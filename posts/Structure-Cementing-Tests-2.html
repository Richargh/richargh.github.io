<!DOCTYPE html>
<html lang="en">
<head>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <meta property="og:site_name" content="Knowledge Continuum"/>
    <meta property="og:description" content="Part 2 - Concepts of the TestDsl">
    <meta property="article:author" content="https://richargh.de/about/"><meta property="og:title" content="Structure-cementing tests and how to avoid them 2/3">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://richargh.de/posts/Structure-Cementing-Tests-2"><title>Richard's Blog</title>

    <link rel="canonical" href="https://richargh.de/posts/Structure-Cementing-Tests-2"/>
    <link rel="apple-touch-icon" href="/assets/img/profile.jpg">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"/>

    <link rel="icon" href="/assets/img/favicon.ico" type="image/png" sizes="16x16"/>
    <link href="/assets/css/style.css" rel="stylesheet" media="all" class="default"/>

    <!--[if IE]>
        <link href="/assets/css/ie-target.css" rel="stylesheet" type="text/css"/>
    <![endif]-->
    <!--<link href="/assets/css/prism.css" rel="stylesheet" />-->
    <link rel="alternate" type="application/rss+xml" href="https://richargh.de/feed.xml">
</head>

<body>
    <div class="container">                    
        <div class = "box"><header>
    <div class="dashboard disable-select">
        <div class="site-heading profile-board-col">
           <h4 class="medium"><a href="/">Richard's Blog</a></h4>
        </div>

        <div class="userboard profile-board-col">
            <div class="username">
                <p class="title-sans">Richard Gro√ü</p>
            </div>
            <div class="userdesc">
                <p class="title-sans">IT Archaeologist</p>
            </div>
        </div>
    </div>
    <div class="avatar disable-select">
        <a class="avatar-link" href="/">
            <img src="/assets/img/profile.jpg" class="avatar-img" alt="avatar"/>
        </a>
    </div>

    <!-- Navbar -->
    <div class="main-site-subheader menu disable-select">
        <div class="talks">
            <a style="text-decoration: none;" href="/talks">
                <!-- from https://www.reshot.com/free-svg-icons/item/speaker-ZQA938GVWS/ -->
                <svg class="icon-talks" width="18" height="19" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 25.983a1 1 0 0 1-.406-.086L4.218 21.29H1a1 1 0 0 1-1-1v-8.614a1 1 0 0 1 1-1h3.218L14.594 6.07A1 1 0 0 1 16 6.983v18a1 1 0 0 1-1 1zM2 19.29h2.43c.14 0 .278.029.405.085L14 23.445V8.52l-9.165 4.07a1.002 1.002 0 0 1-.405.085H2v6.614zM23.698 28a1 1 0 0 1-.39-1.92A10.942 10.942 0 0 0 30 15.982c0-4.379-2.599-8.33-6.62-10.065a1 1 0 0 1-.522-1.314.997.997 0 0 1 1.314-.522A12.95 12.95 0 0 1 32 15.982c0 5.22-3.106 9.906-7.913 11.939a1 1 0 0 1-.39.08z"/>
                    <path d="M22.751 24.051a1 1 0 0 1-.47-1.883A6.993 6.993 0 0 0 26 15.983a6.992 6.992 0 0 0-3.719-6.185 1 1 0 1 1 .939-1.766 8.988 8.988 0 0 1 4.78 7.95 8.988 8.988 0 0 1-4.78 7.952.993.993 0 0 1-.469.117z"/>
                    <path d="M19 20.733a1 1 0 0 1 0-2c1.517 0 2.75-1.233 2.75-2.75s-1.233-2.75-2.75-2.75a1 1 0 0 1 0-2c2.62 0 4.75 2.13 4.75 4.75s-2.13 4.75-4.75 4.75z"/>
                </svg>
                <p class="home-p">Talks</p>
            </a>
        </div>
        <div class="published">
            <a style="text-decoration: none;" href="/published">
                <!-- from https://www.reshot.com/free-svg-icons/item/paper-plane-D72FP5NHXZ/ -->
                <svg class="icon-published" width="25" height="25" viewBox="0 0 2048 2048" xmlns="http://www.w3.org/2000/svg">
                    <g id="Layer_x0020_1"><g id="_559822392"><path id="_559822728" class="fil0" d="M1657.53 872.581 348.07 521.715l493.348 993.204 338.593-451.457-.1-.074a31.858 31.858 0 0 1 16.456-11.467l461.159-179.34zM296.27 441.664l1470.41 393.994c10.174 2.183 19.089 9.275 23.141 19.697 6.406 16.47-1.755 35.018-18.225 41.423l-11.599-29.824 11.5 29.75-545.971 212.322-362.47 483.291a31.844 31.844 0 0 1-12.97 11.81c-15.828 7.86-35.034 1.403-42.895-14.424l28.66-14.236-28.626 14.125L260.4 488.722c-4.181-7.128-5.62-15.863-3.312-24.475 4.573-17.07 22.121-27.201 39.191-22.628l-.01.04z"/><path
                            id="_559822560" class="fil0"
                            d="M305.626 445.908c-14.705-9.733-34.518-5.705-44.251 9-9.734 14.705-5.705 34.518 9 44.251l917.512 610.055c14.705 9.734 34.518 5.705 44.251-9 9.733-14.705 5.705-34.518-9-44.251L305.626 445.908z"/><path
                            id="_559822608" class="fil0"
                            d="M1237.39 1080.09c-1.38-17.604-16.772-30.756-34.376-29.375-17.604 1.38-30.756 16.772-29.375 34.376l28.922 361.603-132.165-169.905c-10.838-13.944-30.931-16.462-44.875-5.625-13.944 10.838-16.462 30.931-5.625 44.875l197.058 253.327c6.326 8.797 16.966 14.166 28.553 13.24 17.617-1.407 30.755-16.833 29.347-34.449l-.026.003-37.437-468.07z"/></g></g>
                    <path style="fill:none" d="M0 0h2048v2048H0z"/>
                </svg>
                <p class="published-p">Published</p>
            </a>
        </div>
        <div class="built">
            <a style="text-decoration: none;" href="/built">
                <!-- from https://www.reshot.com/free-svg-icons/item/tool-UACF35PGN9/ -->
                <svg class="icon-built" width="18" height="19" viewBox="0 0 14 23" xmlns="http://www.w3.org/2000/svg" >
                    <path d="M10 23V13a7.551 7.551 0 0 0 4-6.682A6.992 6.992 0 0 0 10 0v6.318a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V0a6.992 6.992 0 0 0-4 6.318A7.551 7.551 0 0 0 4 13v10h2v-8h2v8z"/>
                </svg>
                <p class="built-p">Built</p>
            </a>
        </div>
        <div class="home">
            <a style="text-decoration: none;" href="/about">
                <svg class="icon-home" width="18" height="19" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20.9777 21.6138V19.6138C20.9777 18.553 20.5563 17.5356 19.8061 16.7854C19.056 16.0353 18.0386 15.6138 16.9777 15.6138H8.97768C7.91682 15.6138 6.8994 16.0353 6.14926 16.7854C5.39911 17.5356 4.97768 18.553 4.97768 19.6138V21.6138"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12.9777 11.6138C15.1868 11.6138 16.9777 9.82298 16.9777 7.61385C16.9777 5.40471 15.1868 3.61385 12.9777 3.61385C10.7685 3.61385 8.97768 5.40471 8.97768 7.61385C8.97768 9.82298 10.7685 11.6138 12.9777 11.6138Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <p class="home-p">About</p>  
            </a>
        </div>
        <div class="categories">
            <a style="text-decoration: none;" href="/tags">
            <svg class="icon-category" width="18" height="19" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 9.5H20"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 15.5H20"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M10 3.5L8 21.5"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M16 3.5L14 21.5"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <p class="categories-p">Tags</p>
            </a>
        </div>
        <div class="rss">
            <a style="text-decoration: none;" href="/feed.xml">
                <svg class="icon-rss" width="18" height="19" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 11.5C6.38695 11.5 8.67613 12.4482 10.364 14.136C12.0518 15.8239 13 18.1131 13 20.5"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M4 4.5C8.24346 4.5 12.3131 6.18571 15.3137 9.18629C18.3143 12.1869 20 16.2565 20 20.5"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M5 20.5C5.55228 20.5 6 20.0523 6 19.5C6 18.9477 5.55228 18.5 5 18.5C4.44772 18.5 4 18.9477 4 19.5C4 20.0523 4.44772 20.5 5 20.5Z"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            <p class="rss-p">RSS</p>
            </a>
        </div>
    </div>
    <div class="searchbar search-container">
        <i class="fa fa-search" aria-hidden="true"></i>
        <label for="search-input"></label>
        <input type="text" oninput="changeResultContainerDisp(this.value)" id="search-input" autocomplete="off" placeholder="Search the Blog..."/>
        <ul id="results-container"></ul>
    </div>
    <script src="/assets/js/simple-jekyll-search.min.js"></script>
    <script>
        function changeResultContainerDisp(val) {
            if (val) {
                document.getElementById("results-container").style.display = "block";
                document.getElementById("search-input").addEventListener('blur', function() {
                    document.addEventListener('click', function(event) {
                        var isClickInside = document.getElementById("results-container").contains(event.target);
                        if (!isClickInside) {
                            document.getElementById("results-container").style.display = "none";
                        }
                    })
                })
            }  else {
                document.getElementById("results-container").style.display = "none";
            }
        }
        var sjs = SimpleJekyllSearch({
                    searchInput: document.getElementById('search-input'),
                    resultsContainer: document.getElementById('results-container'),
                    json: '/search.json',
                    searchResultTemplate: '<li class="search_res" style="list-style: none;"><a href="https://richargh.de{url}" style="text-decoration: none; color: #555555;"><p style="font-size: 1.0rem; font-family: "Inter !important"; font-weight: 600;">{title}</p></a></li>',
                    noResultsText: 'No results found',
                    fuzzy: false,
                    limit: 4
                    })
    </script><div class="main-site-subheader disable-select" id="scroll-head" onclick="window.location.assign('/');">
        <div class="back-icon">
            <svg class="ripple" xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24">
                <path d="M0 0h24v24H0z" fill="none"/>
                <path d="M21 11H6.83l3.58-3.59L9 6l-6 6 6 6 1.41-1.41L6.83 13H21z"/>
            </svg>
        </div>
        <p class="back-p">Home</p>
    </div></header><main>
                <h1>Structure-cementing tests and how to avoid them 2/3</h1><!-- Parse internal links, external links, transclusions etc and manipuate the content to reflect it accordingly --><ul class="tags"><li><a href="/dates/#31-January-2025" class="tag">January-31-2025</a></li>
    <!-- Loop through page categories and print them in tags --><li><a href="/tags/#testing" class="tag">testing</a></li><li><a href="/tags/#architecture" class="tag">architecture</a></li><li><a href="/tags/#cementing" class="tag">cementing</a></li></ul><div class="content"><div class="sect1">
<h2 id="part-2-concepts-of-the-testdsl"><a class="anchor" href="#part-2-concepts-of-the-testdsl"></a><a class="link" href="#part-2-concepts-of-the-testdsl">Part 2 - Concepts of the TestDsl</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>Tests should be sensitive to behavioural changes but be insensitive to structural changes.
Tests that do not fulfil the second condition are called structure-cementing.
In <a href="Structure-Cementing-Tests-1">part 1</a>, we built a TestDsl with which we can completely avoid cementing structure through the test setup.
In this part, we will go into more detail about the concepts of the DSL (Domain-Specific Language <a href="#dsl">[1]</a>) and show why you can use it to write tests that become unit tests after changing just one line of integration.</em></p>
</div>
<div class="paragraph">
<p>The test setup is a series of steps we need to take before we can test our testee.
We need this because certain preconditions are required before we can test the actual behavior.
The TestDsl is an abstraction layer between test and test setup that makes the test setup very comfortable and avoid structural cementation.</p>
</div>
<div class="paragraph">
<p>Let us assume that we want to test a method <code>rentBook(bookId, userId)</code> in a <code>RentingService</code>.
It is very common that this method has the precondition that the book and user must be stored in a <code>Repository</code> before we call <code>rentBook</code>.
Additionally the renting user must exist, have a <code>role</code> and a <code>permission</code> called <code>CAN_RENT_BOOK</code> .</p>
</div>
<div class="paragraph">
<p>If you were to create all the preconditions in each test by hand, you would not only have created a lot of redundancy, but (assuming enough tests) you would also have cemented the structure of all the preconditions. Implementation details, such as what a <code>Role</code> looks like, how it gets into its <code>Repository</code>, how the <code>RentingService</code> gets to that <code>Repository</code>, are cemented with every redundant test setup. This cementation happens because an engineer simply does not want to change a high number of files in order to implement an actually sensible structural change. The engineer feels that the structure is anything but soft and more like cement.</p>
</div>
<div class="paragraph">
<p>If the entire test setup is done  <a href="#fig:testdsl-structure">via the TestDsl</a>, only the Dsl is affected by structure changes and the test is decoupled from the structure. We can make structural changes in the production code without any problems because we only have to make changes in one place, in the Dsl.</p>
</div>
<div id="fig:testdsl-structure" class="imageblock">
<div class="content">
<img src="/assets/img/posts/structure-cementing-tests/part2/LL-Test-Dsl-Layer.png" alt="At the top are the tests. The tests only have dependencies on the Test-D.S.L. The Test-D.S.L. has dependencies on the production code. If production code changes only the D.S.L. has to change but not a single test.">
</div>
<div class="title">Figure 1. The TestDsl inserts itself between tests and the structure of the production code</div>
</div>
<div class="paragraph">
<p>The TestDsl consists of the following parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>TestState</p>
</li>
<li>
<p>Floor</p>
</li>
<li>
<p>Entity (Combo) Builder</p>
</li>
<li>
<p>Test Doubles (instead of structure-cementing mocks)</p>
</li>
<li>
<p>Service Configurator (optional)</p>
</li>
<li>
<p>JUnit extension (optional)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A noticeable amount of code, but not much logic. The code is always about delegating or setting values. This is good. The Dsl should think as little as possible so that we don&#8217;t create a maintenance problem.</p>
</div>
<div class="paragraph">
<p>Clearly, we need to invest code. However, this pays dividends quickly and allows us to write very concise tests (<a href="#lst:testdsl-complete-test-w-extension">the final test from part 1</a>):</p>
</div>
<div id="lst:testdsl-complete-test-w-extension" class="listingblock">
<div class="title">Complete test with TestDsl Extension</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Integration</span> <span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">should_be_able_to_rent_book</span><span class="o">(</span><span class="nc">TestState</span> <span class="n">a</span><span class="o">,</span> <span class="nc">Floor</span> <span class="n">floor</span><span class="o">){</span>
    <span class="c1">// given</span>
    <span class="kt">var</span> <span class="n">book</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">book</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">userCombo</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">userCombo</span><span class="o">(</span><span class="n">it</span> <span class="o">-&gt;</span> <span class="n">it</span><span class="o">.</span><span class="na">hasPermission</span><span class="o">(</span><span class="s">"CAN_RENT_BOOK"</span><span class="o">));</span>
    <span class="n">a</span><span class="o">.</span><span class="na">saveTo</span><span class="o">(</span><span class="n">floor</span><span class="o">);</span>

    <span class="kt">var</span> <span class="n">testee</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RentingService</span><span class="o">(</span><span class="n">floor</span><span class="o">);</span>
    <span class="c1">// WHEN</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="o">=</span> <span class="n">testee</span><span class="o">.</span><span class="na">rentBook</span><span class="o">(</span><span class="n">book</span><span class="o">,</span> <span class="n">userCombo</span><span class="o">.</span><span class="na">user</span><span class="o">());</span>
    <span class="c1">// THEN</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">isRented</span><span class="o">()).</span><span class="na">isTrue</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now also turn <a href="#lst:testdsl-complete-test-w-extension">this test</a> into a quick <code>@Unit</code> test, just by replacing the <code>@Integration</code> annotation. Legacy code in particular benefits from this feature of the TestDsl, because we often still have a lot of logic in the database and have to test at integration level before remediation. Over time, this logic ends up in the domain and we can turn existing tests into significantly faster unit tests with a one-liner. Without a TestDsl, you would have to completely rewrite them at unit level, which is why many teams do not do this, remain stuck with slow integration tests and cannot iterate faster despite tests.</p>
</div>
<div class="paragraph">
<p>In the following chapters, we will see why this is possible and which concepts are behind the Dsl. In Part 3, we will look at the second and final type of structure-cementing tests: Tests that test unstable elements and not modules.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="unit-and-integration-tests"><a class="anchor" href="#unit-and-integration-tests"></a><a class="link" href="#unit-and-integration-tests">Unit and integration tests</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unit and integration tests are very vague terms across the industry (<a href="#test-shapes">[2]</a>, <a href="#google-test-sizes">[3]</a>). Even in small teams there is no clear definition, everyone has their own understanding. So we should pause for a moment and define what we mean when we say <code>@Unit @Test</code>.</p>
</div>
<div class="paragraph">
<p>The test written in part 1 are sociable unit tests <a href="#fowler-unit-test">[4]</a> and follow the unit test definition by Michael Feathers <a href="#feathers-unit-test">[5]</a>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A test is not a unit test if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It talks to the database</p>
</li>
<li>
<p>It communicates across the network</p>
</li>
<li>
<p>It touches the file system</p>
</li>
<li>
<p>It can&#8217;t run at the same time as any of your other unit tests</p>
</li>
<li>
<p>You have to do special things to your environment (such as editing config files) to run it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Tests that do these things aren&#8217;t bad. Often they are worth writing, and they can be written in a unit test harness. However, it is important to be able to separate them from true unit tests so that we can keep a set of tests that we can run fast whenever we make our changes.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Michael Feathers [5]
</div>
</div>
<div class="paragraph">
<p>Around 2010, Google did not know this definition or their teams could not agree on it.
However, they knew that it is hugely beneficial for internal communication if everyone uses the same names for the same things. They couldn&#8217;t agree on the same definitions so they introduced new 'data-driven naming conventions' for tests.
Their definition of a small test is pretty close to Feathers' definition (<a href="#tbl:google-test-sizes">Google Test Sizes</a>) and the medium test provides a pretty good definition of an integration test.</p>
</div>
<table id="tbl:google-test-sizes" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Google Test Sizes <a href="#google-test-sizes">[3]</a></caption>
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 28.5714%;">
<col style="width: 28.5714%;">
<col style="width: 28.5715%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Feature</th>
<th class="tableblock halign-left valign-top">Small (Unit)</th>
<th class="tableblock halign-left valign-top">Medium (Integration)</th>
<th class="tableblock halign-left valign-top">Large (Acceptance)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Network access</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">localhost only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">File system access</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use external systems</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Discouraged</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multiple threads</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sleep statements</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">System properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time limit (seconds)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">60</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">300</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">900+</p></td>
</tr>
</tfoot>
</table>
<div class="paragraph">
<p>The table also shows why unit tests are so fast: there is no <em>out-of-process</em> with which our tested code has to interact.
Everything runs <em>in-process</em> and <em>in-memory</em> and without <em>network</em>.
The perfect basis for the majority of our tests, because the next level of integration or medium can already be significantly slower.
Depending on the test runner and infrastructure, unit tests in customer projects are between 4 and 10 times faster than integration tests.
We were only able to achieve a factor of 4 with our integration tests by parallelising them with a little trick.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip">
</td>
<td class="content">
If each test is given its own namespace in the database (in MongoDb this would be a schema), then each integration test can only see its own data and can only modify its own data. Test isolation is thus restored.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="from-integration-to-unit-test"><a class="anchor" href="#from-integration-to-unit-test"></a><a class="link" href="#from-integration-to-unit-test">From integration to unit test</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>We can convert <a href="#lst:testdsl-complete-test-w-extension">our test</a> from <code>@Integration</code> to <code>@Unit</code> with a one-liner. The JUnit extension switches all repositories in the background. The production repository <code>JpaBooks</code> becomes an <code>InMemoryBooksDouble</code>. The api of the TestDsl remains the same, which is why we no longer need to make any changes to the test. We don&#8217;t have to change anything in the tested code either, because it only contains the <code>interface Books { add(Book book); /* &#8230;&#8203; */ }</code> and not which implementation is behind it.</p>
</div>
<div class="paragraph">
<p>For this change to work so smoothly, however, the <em>InMemory</em> and <em>Jpa</em> repositories must also behave in the same way. In the following chapter, we will see how we can continuously ensure this with the so-called port contract tests.</p>
</div>
<div class="paragraph">
<p>However, it does not always make sense to implement all methods of <code>Books</code> in <code>InMemoryBooksDouble</code> and to keep them synchronised with port contract tests. Sometimes we need the powerful query functionalities of databases not for business logic, but for search functions in the UI. On the one hand, it would be a huge overhead to rebuild these in-memory for a few <code>@Unit</code> tests. On the other hand, these tests would then really only test our InMemory repository implementation. In such cases, we prefer to throw a <code>NotImplementedException</code> in the InMemory double and stick with <code>@Integration</code> tests (for now). We can always change our mind if business logic actually requires the query method.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="keeping-doubles-synchronised-to-production-code-with-port-contract-tests"><a class="anchor" href="#keeping-doubles-synchronised-to-production-code-with-port-contract-tests"></a><a class="link" href="#keeping-doubles-synchronised-to-production-code-with-port-contract-tests">Keeping doubles synchronised to production code with port contract tests</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far we have assumed that a <em>Jpa</em>- can always be replaced by an <em>InMemory</em> repository. This is possible because we combine the <em>Ports &amp; Adapters Architecture</em> <a href="#ports-and-adapters">[6]</a> with so-called port contract tests <a href="#richargh-contract-tests">[23]</a>.</p>
</div>
<div class="paragraph">
<p><em>JpaBooks</em> implements the interface <em>Books</em>. The interface is a so-called <strong>port</strong>. All classes that implement the interface are <strong>adapters</strong> of it. However, the domain logic only knows the ports and not which implementation is behind them. This means that we have decoupled the domain logic from what the code that communicates with the outside world actually looks like. Theoretically, an implementation of the port does not even have to exist when writing the domain logic.</p>
</div>
<div class="paragraph">
<p>The <em>Ports &amp; Adapters Architecture</em> <a href="#ports-and-adapters">[6]</a> helps us design better. We can model the domain logic first before we have to turn to implementation details. The architecture also offers us the option of replacing real adapters with test doubles <a href="#xunit-test-double">[8]</a> for tests. In our unit tests, we therefore use an <em>InMemoryBooksDouble</em> instead of a slower and more expensive <em>JpaBooks</em> repository.</p>
</div>
<div class="paragraph">
<p><em>InMemoryBooksDouble</em> is a specific type of double, a so-called <em>fake</em> <a href="#xunit-fake">[9]</a>. In contrast to the other double types (dummies, stubs, and mocks <a href="#mocks-arent-stubs">[10]</a>), fakes are working implementations of ports that take shortcuts that the production code cannot take, in this case the InMemory solution.</p>
</div>
<div class="paragraph">
<p>In contrast to other doubles, however, the fake must fulfil the expectations that the domain code has of the port. With repositories, for example, the domain code expects that an entity that was added with <code>add()</code> can then also be found again with a <code>find()</code>. The expectations that the domain has of the port are called <strong>contract</strong> and we can check them with a  <a href="#lst:port-contract-test">port contract test</a>.</p>
</div>
<div id="lst:port-contract-test" class="listingblock">
<div class="title">Port Contract Test of our Port</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BooksContract</span> <span class="o">{</span> <img src="./images/icons/callouts/1.png" alt="1">
    <span class="kd">abstract</span> <span class="nc">Books</span> <span class="nf">testee</span><span class="o">();</span> <img src="./images/icons/callouts/2.png" alt="2">

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">should_remember_book</span><span class="o">(</span><span class="nc">TestState</span> <span class="n">a</span><span class="o">){</span> <img src="./images/icons/callouts/3.png" alt="3">
        <span class="c1">// given</span>
        <span class="kt">var</span> <span class="n">book</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">book</span><span class="o">();</span>
        <span class="kt">var</span> <span class="n">testee</span> <span class="o">=</span> <span class="n">testee</span><span class="o">();</span>
        <span class="c1">// when</span>
        <span class="n">testee</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
        <span class="c1">// then</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">testee</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">id</span><span class="o">())).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>The contract is abstract. It only becomes an executable test when it is implemented.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>We only know the port in the test, not the implementation.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/3.png" alt="3"></td>
<td>Each test describes behaviour that we expect from the port.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <a href="#lst:port-adapter-test">implementation test</a> is very short for both the fake and the production adapter.</p>
</div>
<div id="lst:port-adapter-test" class="listingblock">
<div class="title">Test of the Port Adapter</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Unit</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">InMemoryBooksTest</span> <span class="kd">extends</span> <span class="nc">BooksContract</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="nc">Books</span> <span class="nf">testee</span><span class="o">()</span> <span class="o">{</span> <img src="./images/icons/callouts/1.png" alt="1">
        <span class="k">return</span> <span class="k">new</span> <span class="nf">InMemoryBooks</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>Adapter tests usually only implement the method that creates the <code>testee</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And the fake is also very <a href="#lst:inmemory-books-fake">easy to write</a> thanks to a <a href="#lst:base-inmemory-fake">reusable base</a>.</p>
</div>
<div id="lst:inmemory-books-fake" class="listingblock">
<div class="title">An InMemory fake is quick to write thanks to the base class</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InMemoryBooksDouble</span>
            <span class="kd">extends</span> <span class="nc">BaseInMemoryDouble</span><span class="o">&lt;</span><span class="nc">BookId</span><span class="o">,</span> <span class="nc">Book</span><span class="o">&gt;</span>
            <span class="kd">implements</span> <span class="nc">Books</span> <span class="o">{</span>  <img src="./images/icons/callouts/1.png" alt="1"> <img src="./images/icons/callouts/2.png" alt="2">
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>In most repositories, we do not need to implement any special methods here and only use what the base also has.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>Special methods are usually only created by queries. We can solve simple queries with the <code>filter(predicate)</code> method from the <a href="#lst:base-inmemory-fake">base class</a>. For more complex filter methods, however, we can always say that we do not implement them and prefer to use a slower <em>Integration Test</em>.</td>
</tr>
</table>
</div>
<div id="lst:base-inmemory-fake" class="listingblock">
<div class="title">The base class has little logic and always delegates to the JDK map</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BaseInMemoryDouble</span><span class="o">&lt;</span><span class="nc">TId</span><span class="o">,</span> <span class="nc">TEntity</span> <span class="kd">extends</span> <span class="nc">Entity</span><span class="o">&lt;</span><span class="nc">TId</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TId</span><span class="o">,</span> <span class="nc">TEntity</span><span class="o">&gt;</span> <span class="n">entities</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span> <img src="./images/icons/callouts/1.png" alt="1">

    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">TEntity</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="nc">Predicate</span><span class="o">&lt;</span><span class="nc">TEntity</span><span class="o">&gt;</span> <span class="n">predicate</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">entities</span><span class="o">.</span><span class="na">values</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">predicate</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">toList</span><span class="o">();</span> <img src="./images/icons/callouts/2.png" alt="2">
    <span class="o">}</span>

    <img src="./images/icons/callouts/3.png" alt="3">
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>For tests, we only need one HashMap here. However, if we also intend to test parallel code, we should use a ConcurrentHashMap straight away.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>Simple queries can be solved using predicate. For our unit tests, we don&#8217;t need anything complicated with indices because our HashMap only contains a few entities.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/3.png" alt="3"></td>
<td>Other methods such as <code>findById()</code>, <code>add()</code>, <code>remove()</code>, <code>removeIf()</code> and <code>count()</code> only pass through to the (concurrent) HashMap. We do not implement anything special here, but use what the JDK gives us.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With these tests, we can now guarantee that all adapters of the port behave in the same way. They will always be synchronised with what we define as an expectation (aka contract) in the tests.</p>
</div>
<div class="paragraph">
<p>Contract tests are an idea from J. B. Rainsberger <a href="#contract-tests">[11]</a>. We only call them <strong>port</strong> contract tests here to make it more explicit which contract you want to test. This also distinguishes them from the <strong>integration</strong> contract tests <a href="#integration-contract-tests">[12]</a> and the consumer-driven contracts <a href="#consumer-driven-contracts">[13]</a> approach. An alternative name for the port contract tests is role tests <a href="#role-tests">[14]</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="structure-cementing-mocks-and-flexible-doubles"><a class="anchor" href="#structure-cementing-mocks-and-flexible-doubles"></a><a class="link" href="#structure-cementing-mocks-and-flexible-doubles">Structure-cementing mocks and flexible doubles</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In our test, we have so far only used one form of <em>Test Doubles</em> <a href="#xunit-test-double">[8]</a>, the InMemory <em>Fakes</em> <a href="#xunit-fake">[9]</a>. In addition to the fakes, there are also <em>stubs</em>, <em>spies</em> and <em>mocks</em>. They are defined as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Fakes <a href="#xunit-fake">[9]</a></dt>
<dd>
<p>are working implementations that can take shortcuts that the production code cannot take. We keep them synchronised with port contract tests. Fakes can be recognised by the fact that their implementation does roughly the same as the production implementation.</p>
</dd>
<dt class="hdlist1">Stubs <a href="#xunit-stub">[15]</a></dt>
<dd>
<p>allow us to put <strong>indirect inputs</strong> into our test. Indirectly, because these inputs are not passed as parameters to the testee, but the testee pulls the inputs itself. Stubs can be recognised by the fact that we pass them test data, which they return as bluntly as possible when requested by the testee. There is no great logic here.</p>
</dd>
<dt class="hdlist1">Mocks <a href="#xunit-mock">[16]</a></dt>
<dd>
<p>allow us to check <strong>indirect outputs</strong> from our testee. Indirectly, because you don&#8217;t get these outputs as a return value from the testee, but have to retrieve and verify them via detours. This is also known as behaviour verification. Mocks can be recognised by the fact that you ask the mock directly to verify whether it has been called (with certain parameters). The test calls a framework method (<code>verify(mock).didSth(withParam)</code>) or a self-written method (<code>mock.verifyAddWasCalled()</code>).</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>All three <em>Test Doubles</em> can be implemented with a mocking framework, but they can also be implemented without one. Fakes and stubs benefit from implementing them by hand. It&#8217;s not much code, you have a single implementation for multiple tests and the code is easier to read because it is just code and no framework syntax.</p>
</div>
<div class="paragraph">
<p>A mocking framework really only makes sense for mocks because it allows you to specify the expected behavior in the same location as the test. But since you only need mocks very rarely, you only need mocking frameworks very rarely. This is good because the excessive use of the framework also leads <a href="#fig:structure-cement-mock">to structure cementation</a>.</p>
</div>
<div id="fig:structure-cement-mock" class="imageblock">
<div class="content">
<img src="/assets/img/posts/structure-cementing-tests/part2/Cement-structure-via-mock.png" alt="Visualizes that reimplementing the behavior of classes via mocks cements the structure of the production code.">
</div>
<div class="title">Figure 2. Reimplementation of the same method in n tests leads to structure cementation</div>
</div>
<div class="paragraph">
<p>If we reimplement the same methods again and again in <em>n</em> tests, then:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>we cement the design at the type level.</p>
</li>
<li>
<p>our reimplementation may deviate from the real code. The deviation can even be so strong that we break the encapsulation of the port <a href="#stubs-and-mocks-break-encapsulation">[17]</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The former deprives us of the possibility to change our structure. But the latter is perhaps even worse, because our test can be green with the mock, while they would be red with the actual production code. As a result, we no longer trust our tests.</p>
</div>
<div class="paragraph">
<p>In ‚ÄòThe Art of Unit Testing‚Äô <a href="#art-of-unit-testing">[18]</a>, the recommendation is to only use mocks if we want to test the interaction with an external service. Then you only need mocks in 2% to 5% of unit tests.</p>
</div>
<div class="paragraph">
<p>For the vast majority of tests, we therefore use either no double at all (method that only calculates and we can assert on the return value), an (in-memory) fake or a stub and we then write these quickly by hand: <a href="#lst:base-inmemory-fake">fake</a> or <a href="#lst:remote-service-stub">stub</a>.</p>
</div>
<div id="lst:remote-service-stub" class="listingblock">
<div class="title">A simple stub</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">IsbnApiEchoDouble</span> <span class="o">{</span> <img src="./images/icons/callouts/1.png" alt="1">

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">bookTitleEcho</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SomeRemoteApiEchoDouble</span><span class="o">(</span><span class="nc">String</span> <span class="n">bookTitleEcho</span><span class="o">){</span>
	    <span class="k">this</span><span class="o">.</span><span class="na">bookTitleEcho</span> <span class="o">=</span> <span class="n">bookTitleEcho</span> <span class="o">!=</span> <span class="kc">null</span>
                                            <span class="o">?</span> <span class="n">bookTitleEcho</span>
                                            <span class="o">:</span> <span class="s">"Refactoring"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">findTitle</span><span class="o">(</span><span class="nc">Isbn</span> <span class="n">isbn</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">bookTitleEcho</span><span class="o">;</span> <img src="./images/icons/callouts/2.png" alt="2">
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>There are different types of stubs. This one always returns an echo of the values it received in the constructor.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>No special logic here. Just return what you got in the constructor.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Writing it yourself also gives us a single place where we can maintain structural changes to the real port without affecting the test.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="builder-design"><a class="anchor" href="#builder-design"></a><a class="link" href="#builder-design">Builder Design</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The generic <code>with()</code> method accelerates the writing of the <a href="#lst:builder-design">initial builder</a> but requires <em>public</em> fields.</p>
</div>
<div id="lst:builder-design" class="listingblock">
<div class="title">Entity-TestBuilder</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookBuilder</span> <span class="kd">extends</span> <span class="nc">TestBuilder</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">BookId</span> <span class="n">id</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="nc">BookId</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">title</span> <span class="o">=</span> <span class="s">"Refactoring"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">author</span> <span class="o">=</span> <span class="s">"Martin Fowler"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nc">Instant</span> <span class="n">createdOn</span> <span class="o">=</span> <span class="n">clock</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>

    <span class="kd">public</span> <span class="nf">BookBuilder</span><span class="o">(</span><span class="nc">Clock</span> <span class="n">clock</span><span class="o">,</span> <span class="nc">Ids</span> <span class="n">ids</span><span class="o">){</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">clock</span><span class="o">,</span> <span class="n">ids</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Book</span> <span class="nf">build</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Book</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">title</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">BookBuilder</span> <span class="nf">with</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">BookBuilder</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Public fields are a trade-off we can take, at least initially.
Realistically we are going to want to switch to more specific <code>withX()</code> or <code>isX()</code> methods sooner rather than later for one of two reasons:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the new methods make testing more convenient.</p>
</li>
<li>
<p>the new methods don&#8217;t allow error conditions.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Suppose for example we make the author name no longer <em>stringly</em> but <strong>strongly</strong> typed <a href="#stringly-typed">[19]</a> as <code>AuthorName</code> (provides more <em>compile-time safety</em> similar to the Ids). Then the generic <code>with()</code> method is no longer as convenient to use, because we always have to write:</p>
</div>
<div class="paragraph">
<p><code>with(it &#8594; { author = new AuthorName(‚ÄòAlistair‚Äô); })</code></p>
</div>
<div class="paragraph">
<p>To combat this we can introduce a <code>withAuthor(String name)</code> and a <code>withAuthor(AuthorName name)</code> overload to make our builder more convenient to use and keep our tests readable.</p>
</div>
<div class="paragraph">
<p>The second reason happens when two or more fields depend on each other. For example, when a <code>Book</code> gets a field <code>rentedOn</code>. <code>rentedOn</code> must always be after <code>createdOn</code>. With our generic <code>with()</code>, however, we can create an object that is invalid because we have only set <code>rentedOn</code>. This is not a big problem if we always validate in the constructor of a class or record whether the fields (aka the state) are correct. However, <code>BookBuilder</code> would then allow something, which <code>Book</code> then acknowledges in runtime with an <code>IllegalArgumentException</code>.</p>
</div>
<div class="paragraph">
<p>In order to have more compile-time safety again, we can make the field <code>rentedOn</code> private again in the builder and introduce <code>isRentedOn(Duration rentedAfterCreate)</code> together with the overload <code>isRentedOn(Instant createdOn, Duration rentedAfterCreate)</code>. The new prefix, <code>is</code>, shows us that the method conceptually does something different than a <code>with</code>. <code>is</code> declares that the method sets several interdependent values. The overload shows us which value the parameter <code>rentedAfterCreate</code> is dependent on.</p>
</div>
<div class="paragraph">
<p>The new prefix is also there so that we can recognise whether our builder is starting to become too complex. If the number of <code>is</code> methods exceeds the <code>with</code>, then our builder is in dangerous waters.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testdsl-in-combination-with-spring"><a class="anchor" href="#testdsl-in-combination-with-spring"></a><a class="link" href="#testdsl-in-combination-with-spring">TestDsl in combination with Spring</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The JUnit extension written in part 1 can also be made compatible with <code>@SpringBootTest</code>. The extension only has to check whether an ApplicationContext exists. If so, it pulls the floor <a href="#lst:testdsl-extension-w-spring">from the Spring <em>DI-Container</em></a> instead of from the JUnit Store.</p>
</div>
<div id="lst:testdsl-extension-w-spring" class="listingblock">
<div class="title">TestDsl with Floor supplied by Spring</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">resolveParameter</span><span class="o">(</span>
        <span class="nc">ParameterContext</span> <span class="n">parameterContext</span><span class="o">,</span>
        <span class="nc">ExtensionContext</span> <span class="n">extensionContext</span>
    <span class="o">)</span> <span class="kd">throws</span> <span class="nc">ParameterResolutionException</span> <span class="o">{</span>
        <span class="c1">// ...</span>
        <span class="kt">var</span> <span class="n">springFloor</span> <span class="o">=</span> <span class="nc">SpringExtension</span>
            <span class="o">.</span><span class="na">getApplicationContext</span><span class="o">(</span><span class="n">extensionContext</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getBeanProvider</span><span class="o">(</span><span class="nc">Floor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">ifAvailable</span><span class="o">;</span>
        <span class="c1">// ...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the annotation, we can now write the test for <a href="#lst:spring-boot-controller-test">a controller</a>.</p>
</div>
<div id="lst:spring-boot-controller-test" class="listingblock">
<div class="title">SpringBoot Controller Test with TestDsl</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Integration</span> <span class="nd">@SpringBootTest</span> <span class="nd">@Test</span> <img src="./images/icons/callouts/1.png" alt="1">
<span class="kt">void</span> <span class="nf">should_be_able_to_rent_book_via_api</span><span class="o">(</span>
        <span class="nc">TestState</span> <span class="n">a</span><span class="o">,</span>
        <span class="nc">Floor</span> <span class="n">floor</span><span class="o">,</span>
        <span class="nd">@Autowired</span> <span class="nc">BookController</span> <span class="n">testee</span><span class="o">){</span> <img src="./images/icons/callouts/2.png" alt="2">
    <span class="c1">// rest of test</span>
    <img src="./images/icons/callouts/3.png" alt="3">
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>We combine the SpringBootTest annotation with the TestDsl annotation.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>We ask Spring to inject the <code>testee</code>.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/3.png" alt="3"></td>
<td>We can use the TestDsl here as in any other test. The repositories that Spring recognises and those of the TestDsl are the same.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use <code>@SpringBootTest</code> you have to be careful how you write your tests and how extensive they are. The Spring Application Context is cached for tests which overrides the test isolation. Modifications that a test makes can cause a test that runs later to fail. Our tests become brittle.</p>
</div>
<div class="paragraph">
<p>Unit tests should therefore test (functional domains) logic without Spring. This also corresponds to the recommendation that the Spring Framework has made since version 2 <a href="#spring-2-unit-tests">[20]</a> and has maintained up to the current version 6 <a href="#spring-6-unit-tests">[21]</a>. An <code>@Integration @SpringBootTest</code> can be added sporadically for important test paths through the application.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="low-and-high-level-test-dsls"><a class="anchor" href="#low-and-high-level-test-dsls"></a><a class="link" href="#low-and-high-level-test-dsls">Low and High Level Test DSLs</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The TestDsl for <code>@Unit</code> and <code>@Integration</code> shown so far is a <strong>Low-Level</strong> TestDsl. It counteracts structure cementation and makes tests 'under the hood' easier to write. Thanks to direct access to domain objects, we are very flexible as to which test states we can create. We can use it to check the happy path, the sad paths and also many strange paths, i.e. paths that should never actually occur.</p>
</div>
<div class="paragraph">
<p>However, it is not written from the user&#8217;s perspective and cannot be used to verify that the system is behaving correctly from the user&#8217;s perspective. For such tests, we need a running system that we can access from outside via a browser, HttpApi or similar. Google would call these tests ‚ÄòLarge‚Äô <a href="#google-test-sizes">[3]</a> (<a href="#tbl:google-test-sizes">Google Test Sizes</a>). Other common names are system tests or user acceptance tests.</p>
</div>
<div class="paragraph">
<p>For these tests, we need a new Dsl with a different structure but a very similar concept behind it. However, this <strong>high-level</strong> <code>@Acceptance</code> Dsl no longer has anything to do with structure cementation, but with Ui or Api cementation. The more tests we have that require a certain button or a certain widget, the more this UI component is cemented. In the case of a public api, this cementing is perhaps intentional, as you want to offer others a stable api. But even then, a Dsl is recommended because it makes the tests much more readable and maintainable.</p>
</div>
<div class="paragraph">
<p>The High-Level TestDsl briefly outlined below is the implementation of the 4 Layer Acceptance Test Structure by Dave Farley <a href="#acceptance-test-dsl">[22]</a>. The 4 layers are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>top: our test</p>
</li>
<li>
<p>DSL per domain: renting, buying, etc.</p>
</li>
<li>
<p>protocol drivers: UI, API, external system stub</p>
</li>
<li>
<p>the system under test</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When we follow this structure our tests no longer accesses the api of our system directly. There is no <code>http.get(‚Äò/api/users‚Äô)</code>. The test also does not click directly in the browser. There is no <code>page.navigate()</code> or <code>page.click()</code>. The test only recognises the next layer, the Dsl.</p>
</div>
<div class="paragraph">
<p>The Dsl only offers domain-specific user targets, not how the targets are technically implemented (with the <code>renting</code>-Dsl we could implement <code>.findBook(‚ÄòRefactoring‚Äô).rent()</code>, for example). It only recognises the protocol drivers and delegates the implementation to the protocol drivers.</p>
</div>
<div class="paragraph">
<p>Only the drivers know the system to be tested. The UI driver knows how to implement the targets with Playwright, for example, while the Api Protocol Driver can implement the targets using RestAssured, for example. Which driver is used is controlled <a href="#lst:high-level-test-dsl">by annotation</a>.</p>
</div>
<div id="lst:high-level-test-dsl" class="listingblock">
<div class="title">High-Level TestDsl</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Acceptance</span> <span class="nd">@UiProtocol</span> <span class="nd">@ApiProtocol</span> <span class="nd">@Test</span> <img src="./images/icons/callouts/1.png" alt="1">
<span class="kt">void</span> <span class="nf">should_be_able_to_rent_book</span><span class="o">(</span><span class="nc">InventoryDsl</span> <span class="n">inventory</span><span class="o">,</span> <span class="nc">RentingDsl</span> <span class="n">renting</span><span class="o">){</span>
    <span class="c1">// given</span>
    <span class="n">inventory</span><span class="o">.</span><span class="na">addBook</span><span class="o">(</span><span class="s">"Refactoring"</span><span class="o">);</span>  <img src="./images/icons/callouts/2.png" alt="2"> <img src="./images/icons/callouts/3.png" alt="3">
    <span class="kt">var</span> <span class="n">book</span> <span class="o">=</span> <span class="n">renting</span><span class="o">.</span><span class="na">findBook</span><span class="o">(</span><span class="s">"Refactoring"</span><span class="o">);</span>
    <span class="c1">// when</span>
    <span class="n">book</span><span class="o">.</span><span class="na">rent</span><span class="o">();</span>
    <span class="c1">// then</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">isRented</span><span class="o">()).</span><span class="na">isTrue</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>We carry out this test via the browser but also via the HttpApi.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>As with the low-level Dsl, each test must create its complete state.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/3.png" alt="3"></td>
<td>Unlike the low-level Dsl, however, this Dsl takes significantly larger steps. Creating a book can consist of many browser actions or api calls. If one of the intermediate steps fails, the Dsl aborts immediately and provides specific feedback as to which of the intermediate steps did not work.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also <strong>parallelise</strong> these tests in a similar way as we have done with integration tests: we can either provide a namespace per test directly in our system under test or solve this via our Dsl.</p>
</div>
<div class="paragraph">
<p>The former is possible if you build multi-tenant capability into your system right from the start. Each entity then needs an additional <em>TenantId</em> and you have to ensure that everyone can only see the data of their own tenant. If you now create a new tenant for each test and the test also creates all preconditions in the form of entities, then the tests are isolated from each other via the <em>TenantId</em> and can therefore be parallelized.</p>
</div>
<div class="paragraph">
<p>If the <em>TenantId</em> cannot be built directly into the system, the test data aliasing <a href="#acceptance-test-dsl">[22]</a> mentioned by Dave Farley is used. With this pattern, the TestDsl itself ensures that the test data is unique. It then adds a test-unique key to fields. <code>addBook(‚ÄúRefactoring‚Äù)</code> does not create the book ‚ÄúRefactoring‚Äù, but the book ‚ÄúRefactoring dbac1q23‚Äù. <code>findBook(‚ÄúRefactoring‚Äù)</code> does not search for ‚ÄúRefactoring‚Äù, but for ‚ÄúRefactoring dbac1q23‚Äù. When writing the test, however, you must be careful not to assert the number of books or similar, as this could change continuously due to tests running in parallel.</p>
</div>
<div class="paragraph">
<p>Overall, the high-level Dsl described here complements the low-level Dsl with the user view. We write the majority of the tests with the low-level Dsl; we test critical application areas in particular with the high-level Dsl from the user&#8217;s perspective.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="outlook"><a class="anchor" href="#outlook"></a><a class="link" href="#outlook">Outlook</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The TestDsl combines existing concepts such as builders, ports <a href="#ports-and-adapters">[6]</a>, port contract tests <a href="#port-contract-test">[7]</a>, stubs <a href="#mocks-arent-stubs">[10]</a> and fakes <a href="#xunit-fake">[9]</a> and provides a standardized api for all our unit and integration tests. With the TestDsl, we were able to solve structure cementation through redundant test setup. We will show how we use the TestDsl to prevent structure cementing through tests at the wrong level in Part 3.</p>
</div>
<div class="paragraph">
<p>If you are interested in more content about the topic, you can view TestDsl sample code online <a href="#test-dsl">[24]</a> or watch the presentation on ‚ÄúBeehive Architecture‚Äù <a href="#beehive-architecture">[25]</a>, which also revolves around the TestDsl.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">
This article was originally published in <a href="https://www.ijug.eu/de/java-aktuell/zeitschrift/java-aktuell-archiv/detailansicht-java-aktuell/java-aktuell-5-24-cloud/">Java Aktuell 5/24</a> in üá©üá™. It is translated and republished here with the magazine&#8217;s permission.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="references"><a class="anchor" href="#references"></a><a class="link" href="#references">References</a></h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="dsl"></a>[1] M. Fowler, ‚ÄûDomain Specific Language‚Äú. 2008. Available here: <a href="https://martinfowler.com/bliki/DomainSpecificLanguage.html" class="bare">https://martinfowler.com/bliki/DomainSpecificLanguage.html</a></p>
</li>
<li>
<p><a id="test-shapes"></a>[2] M. Fowler, ‚ÄûOn the Diverse And Fantastical Shapes of Testing‚Äú. 2021. Available here: <a href="https://martinfowler.com/articles/2021-test-shapes.html" class="bare">https://martinfowler.com/articles/2021-test-shapes.html</a></p>
</li>
<li>
<p><a id="google-test-sizes"></a>[3] S. Stewart, ‚ÄûTest Sizes‚Äú. 2010. Available here: <a href="https://testing.googleblog.com/2010/12/test-sizes.html" class="bare">https://testing.googleblog.com/2010/12/test-sizes.html</a></p>
</li>
<li>
<p><a id="fowler-unit-test"></a>[4] M. Fowler, ‚ÄûUnit Test‚Äú. 2014. Available here: <a href="https://martinfowler.com/bliki/UnitTest.html#SolitaryOrSociable" class="bare">https://martinfowler.com/bliki/UnitTest.html#SolitaryOrSociable</a></p>
</li>
<li>
<p><a id="feathers-unit-test"></a>[5] M. Feathers, ‚ÄûA Set of Unit Testing Rules‚Äú. 2005. Available here: <a href="https://www.artima.com/weblogs/viewpost.jsp?thread=126923" class="bare">https://www.artima.com/weblogs/viewpost.jsp?thread=126923</a></p>
</li>
<li>
<p><a id="ports-and-adapters"></a>[6] A. Cockburn, ‚ÄûHexagonal architecture‚Äú. 2005. Available here: <a href="https://alistair.cockburn.us/hexagonal-architecture/" class="bare">https://alistair.cockburn.us/hexagonal-architecture/</a></p>
</li>
<li>
<p><a id="port-contract-test"></a>[7] R. Gross, ‚ÄûContract Tests in Kotlin‚Äú. 2020. Available here: <a href="http://richargh.de/posts/Contract-Tests-in-Kotlin" class="bare">http://richargh.de/posts/Contract-Tests-in-Kotlin</a></p>
</li>
<li>
<p><a id="xunit-test-double"></a>[8] G. Meszaros, ‚ÄûTest Double‚Äú. 2011. Available here: <a href="http://xunitpatterns.com/Test%20Double.html" class="bare">http://xunitpatterns.com/Test%20Double.html</a></p>
</li>
<li>
<p><a id="xunit-fake"></a>[9] G. Meszaros, ‚ÄûFake Object‚Äú. 2011. Available here: <a href="http://xunitpatterns.com/Fake%20Object.html" class="bare">http://xunitpatterns.com/Fake%20Object.html</a></p>
</li>
<li>
<p><a id="mocks-arent-stubs"></a>[10] M. Fowler, ‚ÄûMocks Aren‚Äôt Stubs‚Äú. 2007. Available here: <a href="https://martinfowler.com/articles/mocksArentStubs.html" class="bare">https://martinfowler.com/articles/mocksArentStubs.html</a></p>
</li>
<li>
<p><a id="contract-tests"></a>[11] J. B. Rainsberger, ‚ÄûGetting Started with Contract Tests‚Äú. 2017. Available here: <a href="https://blog.thecodewhisperer.com/permalink/getting-started-with-contract-tests" class="bare">https://blog.thecodewhisperer.com/permalink/getting-started-with-contract-tests</a></p>
</li>
<li>
<p><a id="integration-contract-tests"></a>[12] M. Fowler, ‚ÄûIntegration Contract Test‚Äú. 2011. Available here: <a href="https://martinfowler.com/bliki/ContractTest.html" class="bare">https://martinfowler.com/bliki/ContractTest.html</a></p>
</li>
<li>
<p><a id="consumer-driven-contracts"></a>[13] I. Robinson, ‚ÄûConsumer-Driven Contracts: A Service Evolution Pattern‚Äú. 2006. Available here: <a href="https://martinfowler.com/articles/consumerDrivenContracts.html" class="bare">https://martinfowler.com/articles/consumerDrivenContracts.html</a></p>
</li>
<li>
<p><a id="role-tests"></a>[14] M. Rivero, ‚ÄûRole tests for implementation of interfaces discovered through TDD‚Äú. 2022. Available here: <a href="https://codesai.com/posts/2022/04/role-tests" class="bare">https://codesai.com/posts/2022/04/role-tests</a></p>
</li>
<li>
<p><a id="xunit-stub"></a>[15] G. Meszaros, ‚ÄûTest Stub‚Äú. 2011. Available here: <a href="http://xunitpatterns.com/Test%20Stub.html" class="bare">http://xunitpatterns.com/Test%20Stub.html</a></p>
</li>
<li>
<p><a id="xunit-mock"></a>[16] G. Meszaros, ‚ÄûMock Object‚Äú. 2011. Available here: <a href="http://xunitpatterns.com/Mock%20Object.html" class="bare">http://xunitpatterns.com/Mock%20Object.html</a></p>
</li>
<li>
<p><a id="stubs-and-mocks-break-encapsulation"></a>[17] M. Seemann, ‚ÄûStubs and mocks break encapsulation‚Äú. 2022. Available here: <a href="https://blog.ploeh.dk/2022/10/17/stubs-and-mocks-break-encapsulation/" class="bare">https://blog.ploeh.dk/2022/10/17/stubs-and-mocks-break-encapsulation/</a></p>
</li>
<li>
<p><a id="art-of-unit-testing"></a>[18] R. Osherove, ‚ÄûArt of Unit Testing (3. Edition)‚Äú. 2024. Available here: <a href="https://www.artofunittesting.com/" class="bare">https://www.artofunittesting.com/</a></p>
</li>
<li>
<p><a id="stringly-typed"></a>[19] T. Spring, ‚ÄûStringly Typed vs Strongly Typed‚Äú. 2022. Available here: <a href="https://www.hanselman.com/blog/stringly-typed-vs-strongly-typed" class="bare">https://www.hanselman.com/blog/stringly-typed-vs-strongly-typed</a></p>
</li>
<li>
<p><a id="spring-2-unit-tests"></a>[20] T. Spring, ‚ÄûUnit Testing‚Äú. 2006. Available here: <a href="https://docs.spring.io/spring-framework/docs/2.0.4/reference/testing.html#unit-testing" class="bare">https://docs.spring.io/spring-framework/docs/2.0.4/reference/testing.html#unit-testing</a></p>
</li>
<li>
<p><a id="spring-6-unit-tests"></a>[21] T. Spring, ‚ÄûUnit Testing‚Äú. 2022. Available here: <a href="https://docs.spring.io/spring-framework/docs/6.0.0/reference/html/testing.html#unit-testing" class="bare">https://docs.spring.io/spring-framework/docs/6.0.0/reference/html/testing.html#unit-testing</a></p>
</li>
<li>
<p><a id="acceptance-test-dsl"></a>[22] D. Farley, ‚ÄûAcceptance Testing for Continuous Delivery [#AgileIndia2019]‚Äú. 2019. Available here: <a href="https://www.youtube.com/watch?v=Rmz3xobXyV4" class="bare">https://www.youtube.com/watch?v=Rmz3xobXyV4</a></p>
</li>
<li>
<p><a id="richargh-contract-tests"></a>[23] R. Gross, ‚ÄûContract Tests in Kotlin‚Äú. 2020. Available here: <a href="http://richargh.de/posts/Contract-Tests-in-Kotlin" class="bare">http://richargh.de/posts/Contract-Tests-in-Kotlin</a></p>
</li>
<li>
<p><a id="test-dsl"></a>[24] R. Gross, ‚ÄûTestDsl (Avoid structure-cementing Tests)‚Äú. 2024. Available here: <a href="https://github.com/Richargh/testdsl" class="bare">https://github.com/Richargh/testdsl</a></p>
</li>
<li>
<p><a id="beehive-architecture"></a>[25] R. Gross, ‚ÄûBeehive Architecture‚Äú. 2023. Available here: <a href="http://richargh.de/talks/#beehive-architecture" class="bare">http://richargh.de/talks/#beehive-architecture</a></p>
</li>
</ul>
</div>
</div>
</div>
</div><!-- Add backlinks to the current page --><div class="related" id="jekyll-seamless-relatedposts">
    <h4 class="medium-small">Related Posts</h4>
    <div class="related-wrapper"><div class="related-group"><a href="/posts/Structure-Cementing-Tests-1">
            <p class="related-title">Structure-cementing tests and how to avoid them 1/3</p>
            <p class="related-excerpt">
Part 1 - Building a TestDsl


Tests should react to behavioral changes but be insensitive to structural changes. We call tests that do n...</p>
          </a></div></div>
      <br/>
    </div></main><div id="copyright">
    <p id="copyright-notice">¬© Richard Gro√ü
         - with help from <a href="https://jekyllrb.com/">Jekyll</a>
        and <a href="https://github.com/raghuveerdotnet/simply-jekyll">Simply Jekyll Theme</a></p>
</div> </div>
        <button class="scroll-to-top" id="scroll-to-top"><i class="fa fa-chevron-up"></i></button>
    </div>
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <script>
        document.getElementById("scroll-to-top").addEventListener("click", function() {
            window.scrollTo({top: 0, left: 0, behavior: 'smooth'});
        });
    </script></body>
</html>
