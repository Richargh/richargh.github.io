<!DOCTYPE html>
<html lang="en">
<head>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <meta property="og:site_name" content="Knowledge Continuum"/>
    <meta property="og:description" content="Part 1 - Building a TestDsl">
    <meta property="article:author" content="https://richargh.de/about/"><meta property="og:title" content="Structure-cementing tests and how to avoid them 1/3">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://richargh.de/posts/Structure-Cementing-Tests-1"><title>Richard's Blog</title>

    <link rel="canonical" href="https://richargh.de/posts/Structure-Cementing-Tests-1"/>
    <link rel="apple-touch-icon" href="/assets/img/profile.jpg">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"/>

    <link rel="icon" href="/assets/img/favicon.ico" type="image/png" sizes="16x16"/>
    <link href="/assets/css/style.css" rel="stylesheet" media="all" class="default"/>

    <!--[if IE]>
        <link href="/assets/css/ie-target.css" rel="stylesheet" type="text/css"/>
    <![endif]-->
    <!--<link href="/assets/css/prism.css" rel="stylesheet" />-->
    <link rel="alternate" type="application/rss+xml" href="https://richargh.de/feed.xml">
</head>

<body>
    <div class="container">                    
        <div class = "box"><header>
    <div class="dashboard disable-select">
        <div class="site-heading profile-board-col">
           <h4 class="medium"><a href="/">Richard's Blog</a></h4>
        </div>

        <div class="userboard profile-board-col">
            <div class="username">
                <p class="title-sans">Richard Gro√ü</p>
            </div>
            <div class="userdesc">
                <p class="title-sans">IT Archaeologist</p>
            </div>
        </div>
    </div>
    <div class="avatar disable-select">
        <a class="avatar-link" href="/">
            <img src="/assets/img/profile.jpg" class="avatar-img" alt="avatar"/>
        </a>
    </div>

    <!-- Navbar -->
    <div class="main-site-subheader menu disable-select">
        <div class="talks">
            <a style="text-decoration: none;" href="/talks">
                <!-- from https://www.reshot.com/free-svg-icons/item/speaker-ZQA938GVWS/ -->
                <svg class="icon-talks" width="18" height="19" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 25.983a1 1 0 0 1-.406-.086L4.218 21.29H1a1 1 0 0 1-1-1v-8.614a1 1 0 0 1 1-1h3.218L14.594 6.07A1 1 0 0 1 16 6.983v18a1 1 0 0 1-1 1zM2 19.29h2.43c.14 0 .278.029.405.085L14 23.445V8.52l-9.165 4.07a1.002 1.002 0 0 1-.405.085H2v6.614zM23.698 28a1 1 0 0 1-.39-1.92A10.942 10.942 0 0 0 30 15.982c0-4.379-2.599-8.33-6.62-10.065a1 1 0 0 1-.522-1.314.997.997 0 0 1 1.314-.522A12.95 12.95 0 0 1 32 15.982c0 5.22-3.106 9.906-7.913 11.939a1 1 0 0 1-.39.08z"/>
                    <path d="M22.751 24.051a1 1 0 0 1-.47-1.883A6.993 6.993 0 0 0 26 15.983a6.992 6.992 0 0 0-3.719-6.185 1 1 0 1 1 .939-1.766 8.988 8.988 0 0 1 4.78 7.95 8.988 8.988 0 0 1-4.78 7.952.993.993 0 0 1-.469.117z"/>
                    <path d="M19 20.733a1 1 0 0 1 0-2c1.517 0 2.75-1.233 2.75-2.75s-1.233-2.75-2.75-2.75a1 1 0 0 1 0-2c2.62 0 4.75 2.13 4.75 4.75s-2.13 4.75-4.75 4.75z"/>
                </svg>
                <p class="home-p">Talks</p>
            </a>
        </div>
        <div class="published">
            <a style="text-decoration: none;" href="/published">
                <!-- from https://www.reshot.com/free-svg-icons/item/paper-plane-D72FP5NHXZ/ -->
                <svg class="icon-published" width="25" height="25" viewBox="0 0 2048 2048" xmlns="http://www.w3.org/2000/svg">
                    <g id="Layer_x0020_1"><g id="_559822392"><path id="_559822728" class="fil0" d="M1657.53 872.581 348.07 521.715l493.348 993.204 338.593-451.457-.1-.074a31.858 31.858 0 0 1 16.456-11.467l461.159-179.34zM296.27 441.664l1470.41 393.994c10.174 2.183 19.089 9.275 23.141 19.697 6.406 16.47-1.755 35.018-18.225 41.423l-11.599-29.824 11.5 29.75-545.971 212.322-362.47 483.291a31.844 31.844 0 0 1-12.97 11.81c-15.828 7.86-35.034 1.403-42.895-14.424l28.66-14.236-28.626 14.125L260.4 488.722c-4.181-7.128-5.62-15.863-3.312-24.475 4.573-17.07 22.121-27.201 39.191-22.628l-.01.04z"/><path
                            id="_559822560" class="fil0"
                            d="M305.626 445.908c-14.705-9.733-34.518-5.705-44.251 9-9.734 14.705-5.705 34.518 9 44.251l917.512 610.055c14.705 9.734 34.518 5.705 44.251-9 9.733-14.705 5.705-34.518-9-44.251L305.626 445.908z"/><path
                            id="_559822608" class="fil0"
                            d="M1237.39 1080.09c-1.38-17.604-16.772-30.756-34.376-29.375-17.604 1.38-30.756 16.772-29.375 34.376l28.922 361.603-132.165-169.905c-10.838-13.944-30.931-16.462-44.875-5.625-13.944 10.838-16.462 30.931-5.625 44.875l197.058 253.327c6.326 8.797 16.966 14.166 28.553 13.24 17.617-1.407 30.755-16.833 29.347-34.449l-.026.003-37.437-468.07z"/></g></g>
                    <path style="fill:none" d="M0 0h2048v2048H0z"/>
                </svg>
                <p class="published-p">Published</p>
            </a>
        </div>
        <div class="built">
            <a style="text-decoration: none;" href="/built">
                <!-- from https://www.reshot.com/free-svg-icons/item/tool-UACF35PGN9/ -->
                <svg class="icon-built" width="18" height="19" viewBox="0 0 14 23" xmlns="http://www.w3.org/2000/svg" >
                    <path d="M10 23V13a7.551 7.551 0 0 0 4-6.682A6.992 6.992 0 0 0 10 0v6.318a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V0a6.992 6.992 0 0 0-4 6.318A7.551 7.551 0 0 0 4 13v10h2v-8h2v8z"/>
                </svg>
                <p class="built-p">Built</p>
            </a>
        </div>
        <div class="home">
            <a style="text-decoration: none;" href="/about">
                <svg class="icon-home" width="18" height="19" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20.9777 21.6138V19.6138C20.9777 18.553 20.5563 17.5356 19.8061 16.7854C19.056 16.0353 18.0386 15.6138 16.9777 15.6138H8.97768C7.91682 15.6138 6.8994 16.0353 6.14926 16.7854C5.39911 17.5356 4.97768 18.553 4.97768 19.6138V21.6138"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12.9777 11.6138C15.1868 11.6138 16.9777 9.82298 16.9777 7.61385C16.9777 5.40471 15.1868 3.61385 12.9777 3.61385C10.7685 3.61385 8.97768 5.40471 8.97768 7.61385C8.97768 9.82298 10.7685 11.6138 12.9777 11.6138Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <p class="home-p">About</p>  
            </a>
        </div>
        <div class="categories">
            <a style="text-decoration: none;" href="/tags">
            <svg class="icon-category" width="18" height="19" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 9.5H20"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 15.5H20"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M10 3.5L8 21.5"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M16 3.5L14 21.5"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <p class="categories-p">Tags</p>
            </a>
        </div>
        <div class="rss">
            <a style="text-decoration: none;" href="/feed.xml">
                <svg class="icon-rss" width="18" height="19" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 11.5C6.38695 11.5 8.67613 12.4482 10.364 14.136C12.0518 15.8239 13 18.1131 13 20.5"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M4 4.5C8.24346 4.5 12.3131 6.18571 15.3137 9.18629C18.3143 12.1869 20 16.2565 20 20.5"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M5 20.5C5.55228 20.5 6 20.0523 6 19.5C6 18.9477 5.55228 18.5 5 18.5C4.44772 18.5 4 18.9477 4 19.5C4 20.0523 4.44772 20.5 5 20.5Z"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            <p class="rss-p">RSS</p>
            </a>
        </div>
    </div>
    <div class="searchbar search-container">
        <i class="fa fa-search" aria-hidden="true"></i>
        <label for="search-input"></label>
        <input type="text" oninput="changeResultContainerDisp(this.value)" id="search-input" autocomplete="off" placeholder="Search the Blog..."/>
        <ul id="results-container"></ul>
    </div>
    <script src="/assets/js/simple-jekyll-search.min.js"></script>
    <script>
        function changeResultContainerDisp(val) {
            if (val) {
                document.getElementById("results-container").style.display = "block";
                document.getElementById("search-input").addEventListener('blur', function() {
                    document.addEventListener('click', function(event) {
                        var isClickInside = document.getElementById("results-container").contains(event.target);
                        if (!isClickInside) {
                            document.getElementById("results-container").style.display = "none";
                        }
                    })
                })
            }  else {
                document.getElementById("results-container").style.display = "none";
            }
        }
        var sjs = SimpleJekyllSearch({
                    searchInput: document.getElementById('search-input'),
                    resultsContainer: document.getElementById('results-container'),
                    json: '/search.json',
                    searchResultTemplate: '<li class="search_res" style="list-style: none;"><a href="https://richargh.de{url}" style="text-decoration: none; color: #555555;"><p style="font-size: 1.0rem; font-family: "Inter !important"; font-weight: 600;">{title}</p></a></li>',
                    noResultsText: 'No results found',
                    fuzzy: false,
                    limit: 4
                    })
    </script><div class="main-site-subheader disable-select" id="scroll-head" onclick="window.location.assign('/');">
        <div class="back-icon">
            <svg class="ripple" xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24">
                <path d="M0 0h24v24H0z" fill="none"/>
                <path d="M21 11H6.83l3.58-3.59L9 6l-6 6 6 6 1.41-1.41L6.83 13H21z"/>
            </svg>
        </div>
        <p class="back-p">Home</p>
    </div></header><main>
                <h1>Structure-cementing tests and how to avoid them 1/3</h1><!-- Parse internal links, external links, transclusions etc and manipuate the content to reflect it accordingly --><ul class="tags"><li><a href="/dates/#09-November-2024" class="tag">November-09-2024</a></li>
    <!-- Loop through page categories and print them in tags --><li><a href="/tags/#testing" class="tag">testing</a></li><li><a href="/tags/#architecture" class="tag">architecture</a></li><li><a href="/tags/#cementing" class="tag">cementing</a></li></ul><div class="content"><div class="sect1">
<h2 id="part-1-building-a-testdsl"><a class="anchor" href="#part-1-building-a-testdsl"></a><a class="link" href="#part-1-building-a-testdsl">Part 1 - Building a TestDsl</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Tests should react to behavioral changes but be insensitive to structural changes. We call tests that do not fulfill the second condition <strong>structure-cementing</strong>. They make it difficult or even impossible to change the structure and architecture. Teams to whom this happens test and improve less code.</p>
</div>
<div class="paragraph">
<p>With the right approach and a TestDsl, however, we can completely avoid cementation and write tests that turn from integration tests to unit tests after changing <strong>just one line</strong> of test code.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-two-modes-of-development"><a class="anchor" href="#the-two-modes-of-development"></a><a class="link" href="#the-two-modes-of-development">The two modes of development</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>If we change behavior, we should have to change tests. When we restructure code (add, rename or remove methods, classes, parameters or fields) we should not have to change the tests. Both conditions are essential because agile developers are constantly jumping back and forth between the two modes <em>change behavior</em> and <em>change structure</em>.</p>
</div>
<div class="paragraph">
<p>A failing test forces us to jump to the change behavior mode to get it green again. When we get the test green we jump back to change structure mode. The green test now provides the safety net we need to change structure safely. Any time we change the structure (aka refactor) the tests tell us if we did it without changing behavior (<a href="#fig:structure-behavior">see figure</a>). The same applies if we write our tests after the implementation, then the transition between the modes is just not quite as pronounced.</p>
</div>
<div id="fig:structure-behavior" class="imageblock">
<div class="content">
<img src="/assets/img/posts/structure-cementing-tests/part1/Structure-Behavior.png" alt="A picture showing how we go from changing structure to changing behavior with failling and passing tests">
</div>
<div class="title">Figure 1. The two development modes, loosely based on Kent Beck</div>
</div>
<div class="paragraph">
<p><strong>Changing behavior</strong> is of course very risky, because a desired change in behavior can also bring with it an undesirable one. So most of the time we want to spend in <strong>change structure</strong> mode and use techniques like <em>preparatory refactoring</em> <a href="#preparatory-refactoring">[1]</a> that make our behavior change as simple and manageable as possible.</p>
</div>
<div class="paragraph">
<p>However, this also requires tests that allow structural changes and do not cement them. Such tests allow us to proceed in very small and manageable steps. A difficult change is first prepared with 10 to 20 ‚Äúr‚Äù (refactor) commits in order to then make a very small ‚ÄúF‚Äù (feature) commit. The commit format is Arlo&#8217;s Commit Notation <a href="#arlos-commit">[2]</a>, because this models the risk of the commit.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>When faced with a hard change, first make it easy (warning, this may be hard), then make the easy change.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Kent Beck [3]
</div>
</div>
<div class="paragraph">
<p>However, if the structure is cemented, then not only are structural but also feature-related behavioral changes more difficult. This is because we no longer build features where they make sense, but where they are easier to integrate. As a result, the code becomes increasingly confusing. At the beginning, you can no longer find code, it ends up in the simplest place, not the most sensible one. Later on, there are more and more unexpected dependencies, more and more unknown unknowns. We change one place and this leads to a behavior change in a completely different place.</p>
</div>
<div class="paragraph">
<p>The structure-cementing tests have destroyed maintainability. Or we have deleted them and caught regressions.</p>
</div>
<div class="paragraph">
<p>Tests are structure-cementing in two ways:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>through redundancy: tests use the same structure in several places. The more often the same structure (class, method) is required and the more excessively mocked, the more the design is cemented.</p>
</li>
<li>
<p>by testing at the wrong level: we test unstable elements and not modules.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In part 1 of this article series, we look at how we can avoid structure-cementation through redundancy with a TestDsl, in <a href="Structure-Cementing-Tests-2">part 2</a> we explain the concepts of the Dsl in more detail and part 3 deals with the correct test levels.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-initial-test"><a class="anchor" href="#the-initial-test"></a><a class="link" href="#the-initial-test">The initial test</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>We can see the cementation through redundancy in <a href="#lst:initialer-test">Initial test</a>.</p>
</div>
<div id="lst:initialer-test" class="listingblock">
<div class="title">Initial test</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">should_be_able_to_rent_book</span><span class="o">(){</span>
    <span class="c1">// given</span>
    <span class="kt">var</span> <span class="n">book</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Book</span><span class="o">(</span><span class="n">bookId</span><span class="o">(</span><span class="s">"b"</span><span class="o">),</span> <span class="s">"Refactoring"</span><span class="o">,</span> <span class="s">"Martin Fowler"</span><span class="o">);</span> <img src="./images/icons/callouts/1.png" alt="1">
    <span class="kt">var</span> <span class="n">permission</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Permission</span><span class="o">(</span><span class="n">permissionId</span><span class="o">(</span><span class="s">"p"</span><span class="o">),</span> <span class="no">CAN_RENT_BOOK</span><span class="o">);</span>
    <span class="kt">var</span> <span class="n">role</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Role</span><span class="o">(</span><span class="n">roleId</span><span class="o">(</span><span class="s">"r"</span><span class="o">),</span> <span class="s">"Renter"</span><span class="o">,</span> <span class="n">permission</span><span class="o">.</span><span class="na">id</span><span class="o">);</span>
    <span class="kt">var</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="n">userId</span><span class="o">(</span><span class="s">"u"</span><span class="o">,</span> <span class="s">"Alex Mack"</span><span class="o">,</span> <span class="n">role</span><span class="o">.</span><span class="na">id</span><span class="o">));</span>

    <span class="kt">var</span> <span class="n">books</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InMemoryBooksDouble</span><span class="o">();</span> <img src="./images/icons/callouts/2.png" alt="2">
    <span class="kt">var</span> <span class="n">permissions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InMemoryPermissionsDouble</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">roles</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InMemoryRolesDouble</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">users</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InMemoryUsersDouble</span><span class="o">();</span>

    <span class="n">books</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">book</span><span class="o">);</span> <img src="./images/icons/callouts/3.png" alt="3">
    <span class="n">permissions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">permission</span><span class="o">);</span>
    <span class="n">roles</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">role</span><span class="o">);</span>
    <span class="n">users</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>

    <span class="kt">var</span> <span class="n">testee</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RentingService</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClockDouble</span><span class="o">(),</span> <span class="n">books</span><span class="o">,</span> <span class="n">permissions</span><span class="o">,</span> <span class="n">roles</span><span class="o">,</span> <span class="n">users</span> <span class="cm">/* ... */</span><span class="o">);</span> <img src="./images/icons/callouts/4.png" alt="4">
    <span class="c1">// when</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="o">=</span> <span class="n">testee</span><span class="o">.</span><span class="na">rentBook</span><span class="o">(</span><span class="n">book</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span> <img src="./images/icons/callouts/5.png" alt="5">
    <span class="c1">// then</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">isRented</span><span class="o">()).</span><span class="na">isTrue</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>The basis for most of our tests are, in this example, books. Therefore, most of our tests instantiate at least one book and with each redundant instantiation we cement the structure of book more and more, since a change would result in adjustments in hundreds of tests.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>The repositories follow the naming convention <code>+{implementation}+{name of managed entity with plural s}Double</code>. The <em>Double</em> postfix indicates that this is a test double <a href="#xunit-test-double">[4]</a> located in src/testFixtures (or src/test). The postfix is not necessary, but it makes finding all created doubles very convenient.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/3.png" alt="3"></td>
<td>Our code to be tested needs to load the books from the repository, so they must also be stored there first. How this is done is actually an irrelevant implementation detail for the test. However, redundancy in several tests cements this. It also makes the test unnecessarily long.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/4.png" alt="4"></td>
<td>The more often we instantiate the <code>RentingService</code>, the less interest we have in changing its dependencies. The dependencies of our service are cemented.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/5.png" alt="5"></td>
<td>The method whose behavior we actually want to test. Cementing the structure of this method with multiple tests is a tradeoff we want to make because this time we get something back: Feedback. Feedback on whether the method is pleasant and logical to use.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In addition to the test smell ‚Äústructure-cementing‚Äù, this test has a few other problems:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>long test: there is a lot to read and therefore many potentially hidden errors.</p>
</li>
<li>
<p>irrelevant details: Does it have to be a specific book or is any book possible? Do the fields have to have the specified values for the test to be successful?</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We will therefore refactor the test in several steps and work our way towards the final TestDsl [<a href="#lst:testdsl-complete-test-w-extension">Complete test with TestDsl Extension</a>].</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="1-refactoring-factory-methods"><a class="anchor" href="#1-refactoring-factory-methods"></a><a class="link" href="#1-refactoring-factory-methods">1. Refactoring - Factory Methods</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>We can break the redundancy and focus tests by no longer instantiating objects directly, but using factory methods [<a href="#lst:factory-methods">Factory Methods</a>].</p>
</div>
<div id="lst:factory-methods" class="listingblock">
<div class="title">Factory Methods</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">should_be_able_to_rent_book</span><span class="o">(){</span>
    <span class="c1">// given</span>
    <span class="kt">var</span> <span class="n">book</span> <span class="o">=</span> <span class="n">makeBook</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">permission</span> <span class="o">=</span> <span class="n">makePermission</span><span class="o">(</span><span class="no">CAN_RENT_BOOK</span><span class="o">);</span>
    <span class="kt">var</span> <span class="n">role</span> <span class="o">=</span> <span class="n">makeRole</span><span class="o">(</span><span class="n">permission</span><span class="o">);</span>
    <span class="kt">var</span> <span class="n">user</span> <span class="o">=</span> <span class="n">makeUser</span><span class="o">(</span><span class="n">role</span><span class="o">);</span>

    <span class="kt">var</span> <span class="n">books</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InMemoryBooksDouble</span><span class="o">();</span>
    <span class="c1">// remaining Test</span>
    <span class="c1">// ...</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="nc">Book</span> <span class="nf">makeBook</span><span class="o">(){</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">Book</span><span class="o">(</span><span class="n">bookId</span><span class="o">(</span><span class="s">"b"</span><span class="o">),</span> <span class="s">"Refactoring"</span><span class="o">,</span> <span class="s">"Martin Fowler"</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For this small example this is fine, but we quickly run into many problems with this approach (which is also known as the object-mother <a href="#object-mother">[5]</a> pattern):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>either each new use case gets a new method (<code>makeBook()</code>, <code>makeExpensiveBook()</code> etc.).</p>
</li>
<li>
<p>or the method gets dozens of optional parameters without it being clear which parameters are dependent on each other.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This does not mean that factory methods should not be used. Especially when introducing new structures, factory methods are great because we can create them directly in the test class where we need them. However, if we are more sure about our structure, we should first use the <code>Builder</code> from the next section [<a href="#lst:entity-test-builder">Builder Methods</a>] within the factory method and then inline it with our refactoring tools.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="2-refactoring-simple-builder"><a class="anchor" href="#2-refactoring-simple-builder"></a><a class="link" href="#2-refactoring-simple-builder">2. Refactoring - Simple Builder</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Instead of the factory method or the object-mother pattern, we prefer to use a builder [<a href="#lst:entity-test-builder">Builder Methods</a>].</p>
</div>
<div id="lst:entity-test-builder" class="listingblock">
<div class="title">Builder Methods</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">should_be_able_to_rent_book</span><span class="o">(){</span>
    <span class="c1">// given</span>
    <span class="kt">var</span> <span class="n">book</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BookBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">permission</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PermissionBuilder</span><span class="o">().</span><span class="na">withPermission</span><span class="o">(</span><span class="no">CAN_RENT_BOOK</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">role</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RoleBuilder</span><span class="o">().</span><span class="na">withPermissions</span><span class="o">(</span><span class="n">permission</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserBuilder</span><span class="o">().</span><span class="na">withRole</span><span class="o">(</span><span class="n">role</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>

    <span class="kt">var</span> <span class="n">books</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InMemoryBooksDouble</span><span class="o">();</span>
    <span class="c1">// remaining Test</span>
    <span class="c1">// ...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you call the <code>build()</code> method directly, the entity is assigned default values. With the <code>withX()</code> methods, we can adapt the default values to our specific test if necessary. We are therefore much more flexible than with the Factories/Object Mother pattern, because not every case needs its own method.</p>
</div>
<div class="paragraph">
<p>With the builder, we have also redirected the redundant dependencies to a test-specific abstraction [<a href="#fig:structure-cement-init">Cementing structure by init</a>]. We now only have to make changes to the structure of the entity in the builder, not in n tests. We can maintain the structural changes in the builder because we are protected by the tests that already use the builder. If existing tests become red, we have broken something.</p>
</div>
<div id="fig:structure-cement-init" class="imageblock">
<div class="content">
<img src="/assets/img/posts/structure-cementing-tests/part1/Structure-cementing-via-init.png" alt="A picture showing">
</div>
<div class="title">Figure 2. Cementing structure by init</div>
</div>
<div class="paragraph">
<p>In addition to flexible test setup and avoiding the cementing of structure, such a <code>Builder</code> offers us a few more advantages:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the test <strong>no longer mentions irrelevant details</strong>. The above test shows us that it needs any book and not a specific one.</p>
</li>
<li>
<p>the builder highlights <strong>essential differences</strong> between the tests. By using the <code>with()</code> method, we see that the user in the test absolutely needs the <code>CAN_RENT_BOOK</code> permission.</p>
</li>
<li>
<p>in the builder we have a unique place to store technically meaningful default values [<a href="#lst:builder-value-example">Entity-TestBuilder</a>]. Practical documentation for developers.</p>
</li>
</ol>
</div>
<div id="lst:builder-value-example" class="listingblock">
<div class="title">Entity-TestBuilder</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookBuilder</span> <span class="kd">extends</span> <span class="nc">TestBuilder</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">BookId</span> <span class="n">id</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="nc">BookId</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">title</span> <span class="o">=</span> <span class="s">"Refactoring"</span><span class="o">;</span> <img src="./images/icons/callouts/1.png" alt="1">
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">author</span> <span class="o">=</span> <span class="s">"Martin Fowler"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nc">Instant</span> <span class="n">createdOn</span> <span class="o">=</span> <span class="n">clock</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>

    <span class="kd">public</span> <span class="nf">BookBuilder</span><span class="o">(</span><span class="nc">Clock</span> <span class="n">clock</span><span class="o">,</span> <span class="nc">Ids</span> <span class="n">ids</span><span class="o">){</span> <img src="./images/icons/callouts/2.png" alt="2">
        <span class="kd">super</span><span class="o">(</span><span class="n">clock</span><span class="o">,</span> <span class="n">ids</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">BookBuilder</span><span class="o">(){</span> <img src="./images/icons/callouts/3.png" alt="3">
        <span class="k">this</span><span class="o">(</span><span class="n">globalTestClock</span><span class="o">,</span> <span class="n">globalTestIds</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Book</span> <span class="nf">build</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Book</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">title</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">BookBuilder</span> <span class="nf">with</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">BookBuilder</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span> <img src="./images/icons/callouts/4.png" alt="4">
        <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <img src="./images/icons/callouts/5.png" alt="5">
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>Useful defaults that are representative for the production are stored here.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>We already design the builder so we can enter the two main sources of non-deterministic tests (time and random values) from outside.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/3.png" alt="3"></td>
<td>With the TestDsl refactoring, this parameterless constructor is omitted.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/4.png" alt="4"></td>
<td>The <code>with()</code> method speeds up the writing of the initial builder. However, you then have to get used to the fact that the builder has <em>public</em> fields. This is a trade-off that can be made for tests. The specific <code>withX()</code> are more flexible because they can be overloaded though.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/5.png" alt="5"></td>
<td>As an alternative to the generic <code>with()</code>, you can introduce field-specific <code>withX()</code> methods below.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>However, we are not finished yet, because the combination of permission, role and user can be modeled even more strongly and the test can be further focused.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="3-refactoring-combo-builder"><a class="anchor" href="#3-refactoring-combo-builder"></a><a class="link" href="#3-refactoring-combo-builder">3. Refactoring - Combo Builder</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>We introduce the concept of the <em>Combo</em> Builder [<a href="#lst:combo-test-builder-usage">Using the ComboBuilder</a>] so that we can build several separately stored objects in a coordinated manner.</p>
</div>
<div id="lst:combo-test-builder-usage" class="listingblock">
<div class="title">Using the ComboBuilder</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">should_be_able_to_rent_book</span><span class="o">(){</span>
    <span class="c1">// given</span>
    <span class="kt">var</span> <span class="n">book</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BookBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">();</span> <img src="./images/icons/callouts/1.png" alt="1">
    <span class="kt">var</span> <span class="n">userCombo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserComboBuilder</span><span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="n">it</span> <span class="o">-&gt;</span>
        <span class="n">it</span><span class="o">.</span><span class="na">hasPermissions</span><span class="o">(</span><span class="no">CAN_RENT_BOOK</span><span class="o">)</span>
    <span class="o">).</span><span class="na">build</span><span class="o">();</span>
    <span class="c1">// Combo includes:</span>
    <span class="c1">// var permissions = userCombo.permissions();</span>
    <span class="c1">//   var role = userCombo.role();</span>
    <span class="c1">//   var user = userCombo.user();</span>

    <span class="kt">var</span> <span class="n">books</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InMemoryBooksDouble</span><span class="o">();</span>
    <span class="c1">// remaining Test</span>
    <span class="c1">// ...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To keep the complexity of the combo builder low, it only ever builds standard cases [<a href="#lst:combo-test-builder-design">Entity-ComboBuilder</a>]. For more difficult and atypical situations, e.g. if a user has several roles, the individual builders of permission, role and user are used again. This is important because all the special cases will create a lot of unmaintainable code. The rule of thumb is that a builder should never contain <code>if</code> or <code>switch</code>.</p>
</div>
<div id="lst:combo-test-builder-design" class="listingblock">
<div class="title">Entity-ComboBuilder</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserComboBuilder</span> <span class="kd">implements</span> <span class="nc">TestBuilder</span><span class="o">&lt;</span><span class="nc">UserCombo</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// combination fields</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Permission</span><span class="o">&gt;</span> <span class="n">permissions</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>

    <span class="kd">public</span> <span class="nc">UserCombo</span> <span class="nf">build</span><span class="o">(){</span>
        <span class="kt">var</span> <span class="n">role</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RoleBuilder</span><span class="o">().</span><span class="na">withPermissions</span><span class="o">(</span><span class="n">permissions</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="kt">var</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserBuilder</span><span class="o">().</span><span class="na">withRole</span><span class="o">(</span><span class="n">role</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">UserCombo</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">role</span><span class="o">,</span> <span class="n">permissions</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">UserBundleBuilder</span> <span class="nf">hasPermissions</span><span class="o">(</span><span class="nc">PermissionCode</span><span class="o">...</span> <span class="n">permissionCode</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">permissions</span> <span class="o">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">permissionCode</span><span class="o">)</span>
            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">code</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Permission</span><span class="o">(</span><span class="n">code</span><span class="o">))</span>
            <span class="o">.</span><span class="na">toList</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the builder has already streamlined the test considerably. However, we still have the implementation detail of the repositories. We still need to store created entities in repositories and the test needs to know how to do this.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="4-refactoring-testdsl"><a class="anchor" href="#4-refactoring-testdsl"></a><a class="link" href="#4-refactoring-testdsl">4. Refactoring - TestDsl</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>First we introduce the <a href="#lst:testdsl-teststate">TestState</a>.</p>
</div>
<div id="lst:testdsl-teststate" class="listingblock">
<div class="title">Using the TestState</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="nc">TestState</span> <span class="n">a</span><span class="o">;</span> <img src="./images/icons/callouts/1.png" alt="1">

<span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">should_be_able_to_rent_book</span><span class="o">(){</span>
    <span class="c1">// given</span>
    <span class="kt">var</span> <span class="n">book</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">book</span><span class="o">();</span> <img src="./images/icons/callouts/2.png" alt="2">
    <span class="kt">var</span> <span class="n">userCombo</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">userCombo</span><span class="o">(</span><span class="n">it</span> <span class="o">-&gt;</span> <span class="n">it</span><span class="o">.</span><span class="na">hasPermission</span><span class="o">(</span><span class="no">CAN_RENT_BOOK</span><span class="o">));</span>

    <span class="kt">var</span> <span class="n">books</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InMemoryBooksDouble</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">permissions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InMemoryPermissionsDouble</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">roles</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InMemoryRolesDouble</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">users</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InMemoryUsersDouble</span><span class="o">();</span>

    <span class="n">books</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
    <span class="n">permissions</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">userCombo</span><span class="o">.</span><span class="na">permissions</span><span class="o">());</span>
    <span class="n">roles</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">userCombo</span><span class="o">.</span><span class="na">role</span><span class="o">());</span>
    <span class="n">users</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">userCombo</span><span class="o">.</span><span class="na">user</span><span class="o">());</span>

    <span class="kt">var</span> <span class="n">testee</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RentingService</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClockDouble</span><span class="o">(),</span> <span class="n">books</span><span class="o">,</span> <span class="n">permissions</span><span class="o">,</span> <span class="n">roles</span><span class="o">,</span> <span class="n">users</span> <span class="cm">/* ... */</span><span class="o">);</span>
    <span class="c1">// WHEN + THEN</span>
    <span class="c1">// ...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>The TestState is a class that knows all builders.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>Build tasks are always delegated to the already written builders.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At first glance, we only gain some compactness: <code>xyzBuilder()</code> no longer needs to be instantiated and we don&#8217;t need a <code>.build()</code> method. Behind the scenes, however, we have gained much more. The <code>TestState</code> is now a central point that recognizes all created entities. We can therefore ask the state to store all created entities in the repositories and streamline our test even further [<a href="#lst:testdsl-floor">Saving state to the floor</a>].</p>
</div>
<div id="lst:testdsl-floor" class="listingblock">
<div class="title">Saving state to the floor</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="nc">TestState</span> <span class="n">a</span><span class="o">;</span>
<span class="kd">private</span> <span class="nc">Floor</span> <span class="n">floor</span><span class="o">;</span> <span class="c1">// contains the floor that the application is build on</span>

<span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">should_be_able_to_rent_book</span><span class="o">(){</span>
    <span class="c1">// given</span>
    <span class="kt">var</span> <span class="n">book</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">book</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">userCombo</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">userCombo</span><span class="o">(</span><span class="n">it</span> <span class="o">-&gt;</span> <span class="n">it</span><span class="o">.</span><span class="na">hasPermission</span><span class="o">(</span><span class="no">CAN_RENT_BOOK</span><span class="o">));</span>
    <span class="n">a</span><span class="o">.</span><span class="na">saveTo</span><span class="o">(</span><span class="n">floor</span><span class="o">);</span>  <img src="./images/icons/callouts/1.png" alt="1"> <img src="./images/icons/callouts/2.png" alt="2">

    <span class="kt">var</span> <span class="n">testee</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RentingService</span><span class="o">(</span><span class="n">floor</span><span class="o">);</span> <img src="./images/icons/callouts/3.png" alt="3">
    <span class="c1">// WHEN + THEN</span>
    <span class="c1">// ...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>With this call, we save <code>book</code>, <code>permission</code>, <code>role</code> and <code>user</code> in the respective repositories. Theoretically, the call to <code>a.book();</code> could already have saved the book in the <code>BookRepository</code>. However, the <code>saveTo()</code> makes saving more explicit and also offers the flexibility to create entities that do not automatically end up in repositories.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>We group all <code>Ports</code> into the outside world in the so-called <code>Floor</code>, the floor on which our application stands. A repository is such a <code>Port</code>, just like <code>Clock</code> or an external <code>Client</code>. The <em>Floor</em> allows us to flexibly control how our <em>testee</em> communicates with the outside world in tests. We can <strong>pull the floor out from under the feet of our application in tests and set up a much more testable floor</strong>. In the <em>ports &amp; adapters architecture</em> <a href="#ports-and-adapters">[6]</a>, the <code>floor</code> is synonymous with the <em>driven</em> but not the <em>driving</em> ports. Since it is easy to overlook whether something is <em>driven</em> or <em>driving</em>, the terms were out of the question. <code>Floor</code> was chosen as an identifier because it is short and thus provides an analogy for software <s>architects</s> gardeners who take care of the <em>Forest</em> <code>Floor</code>, the <em>Forest</em> <code>Canopy</code> and the forest. Alternative names for <em>driven</em> (=outcomes) or <em>driving</em> (=triggers) <code>Port</code> were not known at the time.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/3.png" alt="3"></td>
<td>We made the <code>Floor</code> part of our production code. To instantiate service classes, you only ever need the <code>Floor</code> [<a href="#lst:first-class-floor">RentingServices extracts only required dependencies</a>] and no longer have to write the concrete dependencies.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To simplify the dependency management we pass floor directly to the constructor of our production services [<a href="#lst:first-class-floor">RentingServices extracts only required dependencies</a>]. We don&#8217;t have to do this to utilize the TestDsl. Alternatively, we could have left the constructor of the service as it is and written a <code>configureRentingService(floor)</code> method for tests that assigns dependencies from the <code>Floor</code>. Both ways avoid the structure cementation of the <code>RentingService</code>. If we were to use an <em>DI-Container</em> like Spring to instantiate the service, we would have the same advantage. However, many of these containers make tests slower due to their startup overhead and make test parallelization more difficult due to context caching, which is why they are not a good choice for unit tests. In general we should write unit tests without such containers. This recommendation is also shared by the Spring Framework <a href="#spring-2-unit-tests">[7]</a>.</p>
</div>
<div id="lst:first-class-floor" class="listingblock">
<div class="title">RentingServices extracts only required dependencies</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RentingService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Clock</span> <span class="n">clock</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Books</span> <span class="n">books</span><span class="o">;</span>
    <span class="c1">// etc.</span>

    <span class="kd">public</span> <span class="nf">RentingService</span><span class="o">(</span><span class="nc">Floor</span> <span class="n">floor</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">clock</span> <span class="o">=</span> <span class="n">floor</span><span class="o">.</span><span class="na">clock</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">books</span> <span class="o">=</span> <span class="n">floor</span><span class="o">.</span><span class="na">books</span><span class="o">();</span>
        <span class="c1">// etc.</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To ensure that the tests are isolated from each other, we instantiate TestState and Floor for each test [<a href="#lst:testdsl-init-before-each">Instantiate TestDsl in BeforeEach</a>].</p>
</div>
<div id="lst:testdsl-init-before-each" class="listingblock">
<div class="title">Instantiate TestDsl in BeforeEach</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="nc">TestState</span> <span class="n">a</span><span class="o">;</span>
<span class="kd">private</span> <span class="nc">Floor</span> <span class="n">floor</span><span class="o">;</span>

<span class="nd">@BeforeEach</span>
<span class="kt">void</span> <span class="nf">init</span><span class="o">(){</span>
    <span class="kt">var</span> <span class="n">dsl</span> <span class="o">=</span> <span class="nc">TestDsl</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">unitFloor</span><span class="o">());</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">dsl</span><span class="o">.</span><span class="na">testState</span><span class="o">();</span>
    <span class="n">floor</span> <span class="o">=</span> <span class="n">dsl</span><span class="o">.</span><span class="na">floor</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The floor itself is simply an interface that recognizes all dependencies [<a href="#lst:floor">Floor of the TestDsl</a>]. The unit test implementation <code>unitFloor()</code> then returns <em>InMemoryDoubles</em> when the methods are called.</p>
</div>
<div id="lst:floor" class="listingblock">
<div class="title">Floor of the TestDsl</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Floor</span> <span class="o">{</span>
    <span class="nc">Clock</span> <span class="nf">clock</span><span class="o">();</span>
    <span class="nc">Books</span> <span class="nf">books</span><span class="o">();</span>
    <span class="c1">// etc.</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The sum of these changes is that our test looks very compact [<a href="#lst:testdsl-complete-test-with-before-each">Complete test with TestDsl</a>].</p>
</div>
<div id="lst:testdsl-complete-test-with-before-each" class="listingblock">
<div class="title">Complete test with TestDsl</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="nc">TestState</span> <span class="n">a</span><span class="o">;</span>
<span class="kd">private</span> <span class="nc">Floor</span> <span class="n">floor</span><span class="o">;</span>

<span class="nd">@BeforeEach</span>
<span class="kt">void</span> <span class="nf">init</span><span class="o">(){</span>
    <span class="kt">var</span> <span class="n">dsl</span> <span class="o">=</span> <span class="nc">TestDsl</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">unitFloor</span><span class="o">());</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">dsl</span><span class="o">.</span><span class="na">testState</span><span class="o">();</span>
    <span class="n">floor</span> <span class="o">=</span> <span class="n">dsl</span><span class="o">.</span><span class="na">floor</span><span class="o">();</span>
<span class="o">}</span>

<span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">should_be_able_to_rent_book</span><span class="o">(){</span>
    <span class="c1">// given</span>
    <span class="kt">var</span> <span class="n">book</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">book</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">userCombo</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">userCombo</span><span class="o">(</span><span class="n">it</span> <span class="o">-&gt;</span> <span class="n">it</span><span class="o">.</span><span class="na">hasPermission</span><span class="o">(</span><span class="no">CAN_RENT_BOOK</span><span class="o">));</span>
    <span class="n">a</span><span class="o">.</span><span class="na">saveTo</span><span class="o">(</span><span class="n">floor</span><span class="o">);</span>

    <span class="kt">var</span> <span class="n">testee</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RentingService</span><span class="o">(</span><span class="n">floor</span><span class="o">);</span>
    <span class="c1">// WHEN</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="o">=</span> <span class="n">testee</span><span class="o">.</span><span class="na">rentBook</span><span class="o">(</span><span class="n">book</span><span class="o">,</span> <span class="n">userCombo</span><span class="o">.</span><span class="na">user</span><span class="o">());</span>
    <span class="c1">// THEN</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">isRented</span><span class="o">()).</span><span class="na">isTrue</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We have already come a long way with this refactoring:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>we were able to map the setup for our test in just 4 lines.</p>
</li>
<li>
<p>we were able to write the entire setup in the same place as our test. You can see at a glance which preconditions the test requires and you don&#8217;t have to scroll or open another file to understand the context.</p>
</li>
<li>
<p>we were able to hide irrelevant details (any <code>book</code> and any <code>user</code> will do) and highlight relevant ones (the <code>user</code> needs the <code>CAN_RENT_BOOK</code> permission).</p>
</li>
<li>
<p>we have a standardized way to do the test setup for all tests.</p>
</li>
<li>
<p>we were able to avoid a structure-cementing test setup.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>However, we can still make one improvement.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="5-refactoring-extension"><a class="anchor" href="#5-refactoring-extension"></a><a class="link" href="#5-refactoring-extension">5. Refactoring - Extension</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far we have to write redundant initialization code for the TestDsl in the <code>@BeforeEach</code> block in every test. If we are using JUnit5, we can make it reusable for multiple tests with an annotation [<a href="#lst:testdsl-complete-test-w-extension">Complete test with TestDsl Extension</a>].</p>
</div>
<div id="lst:testdsl-complete-test-w-extension" class="listingblock">
<div class="title">Complete test with TestDsl Extension</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Unit</span> <span class="nd">@Test</span> <img src="./images/icons/callouts/1.png" alt="1">
<span class="kt">void</span> <span class="nf">should_be_able_to_rent_book</span><span class="o">(</span><span class="nc">TestState</span> <span class="n">a</span><span class="o">,</span> <span class="nc">Floor</span> <span class="n">floor</span><span class="o">){</span> <img src="./images/icons/callouts/2.png" alt="2">
    <span class="c1">// given</span>
    <span class="kt">var</span> <span class="n">book</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">book</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">userCombo</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">userCombo</span><span class="o">(</span><span class="n">it</span> <span class="o">-&gt;</span> <span class="n">it</span><span class="o">.</span><span class="na">hasPermission</span><span class="o">(</span><span class="s">"CAN_RENT_BOOK"</span><span class="o">));</span>
    <span class="n">a</span><span class="o">.</span><span class="na">saveTo</span><span class="o">(</span><span class="n">floor</span><span class="o">);</span>

    <span class="kt">var</span> <span class="n">testee</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RentingService</span><span class="o">(</span><span class="n">floor</span><span class="o">);</span>
    <span class="c1">// WHEN</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="o">=</span> <span class="n">testee</span><span class="o">.</span><span class="na">rentBook</span><span class="o">(</span><span class="n">book</span><span class="o">,</span> <span class="n">userCombo</span><span class="o">.</span><span class="na">user</span><span class="o">());</span>
    <span class="c1">// THEN</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">isRented</span><span class="o">()).</span><span class="na">isTrue</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>Our <code>@BeforeEach</code> is completely merged into the annotation <code>@Unit</code>.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>The annotation turns the two parts of our Dsl into parameters of the test.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The new annotation registers a JUnit 5 extension <a href="#junit5-user-guide-extension-model">[8]</a>. Such an extension can react to the test LifeCycle by implementing special interfaces. We are only interested in <code>ParameterResolver</code> because it resolves the parameters <code>TestState</code> and <code>Floor</code> [<a href="#lst:testdsl-extension">resolveParameter() of the TestDsl extension</a>] that our test requires.</p>
</div>
<div id="lst:testdsl-extension" class="listingblock">
<div class="title">resolveParameter() of the TestDsl extension</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Target</span><span class="o">({</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">jupiter</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">ExtendWith</span><span class="o">(</span><span class="nc">UnitTestExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <img src="./images/icons/callouts/1.png" alt="1">
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">Unit</span> <span class="o">{</span> <span class="o">}</span> <img src="./images/icons/callouts/2.png" alt="2">

<span class="kd">class</span> <span class="nc">UnitTestExtension</span> <span class="kd">implements</span> <span class="nc">ParameterResolver</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">resolveParameter</span><span class="o">(</span>
            <span class="nc">ParameterContext</span> <span class="n">parameterContext</span><span class="o">,</span>
            <span class="nc">ExtensionContext</span> <span class="n">extensionContext</span>
        <span class="o">)</span> <span class="kd">throws</span> <span class="nc">ParameterResolutionException</span> <span class="o">{</span>

        <span class="kt">var</span> <span class="n">storeNamespace</span> <span class="o">=</span> <span class="nc">Namespace</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
            <span class="n">getClass</span><span class="o">(),</span> <span class="n">context</span><span class="o">.</span><span class="na">getRequiredTestMethod</span><span class="o">());</span>
        <span class="kt">var</span> <span class="n">store</span> <span class="o">=</span> <span class="n">extensionContext</span><span class="o">.</span><span class="na">getStore</span><span class="o">(</span><span class="n">store</span><span class="o">);</span> <img src="./images/icons/callouts/3.png" alt="3">

        <span class="kt">var</span> <span class="n">dsl</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getOrComputeIfAbsent</span><span class="o">(</span>
            <span class="s">"UNIT_TEST_DSL"</span><span class="o">,</span>
            <span class="o">(</span><span class="n">key</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">testDslOf</span><span class="o">(</span><span class="n">unitFloor</span><span class="o">()),</span> <img src="./images/icons/callouts/4.png" alt="4">
            <span class="nc">UnitTestDsl</span><span class="o">.</span><span class="na">class</span>
        <span class="o">);</span>

        <span class="kt">var</span> <span class="n">parameterType</span> <span class="o">=</span> <span class="n">parameterContext</span><span class="o">.</span><span class="na">getParameter</span><span class="o">().</span><span class="na">getType</span><span class="o">();</span> <img src="./images/icons/callouts/5.png" alt="5">
        <span class="k">if</span> <span class="o">(</span><span class="n">parameterType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">TestState</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
            <span class="k">return</span> <span class="n">dsl</span><span class="o">.</span><span class="na">testState</span><span class="o">();</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">parameterType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">Floor</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
            <span class="k">return</span> <span class="n">dsl</span><span class="o">.</span><span class="na">floor</span><span class="o">();</span>
        <span class="k">else</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ParameterResolutionException</span><span class="o">(</span><span class="s">"..."</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// ...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>With <code>@ExtendWith</code> we connect annotation with the extension code.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>A normal Java annotation. The name is freely selectable.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/3.png" alt="3"></td>
<td>Extensions must always save state in a store. This is unique per namespace.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/4.png" alt="4"></td>
<td>This creator function is used if no Dsl has yet been created for the test. The <code>resolveParameter()</code> method is called exactly twice per test. Once for the <code>TestState</code> and once for the <code>Floor</code>. We use <code>getOrComputeIfAbsent()</code> so that the same instance of the Dsl is returned.</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/5.png" alt="5"></td>
<td>We use the parameterType to recognize what is to be returned.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In addition to the UnitTest extension shown here, we can of course write another extension, the <code>IntegrationTestExtension</code>. This looks the same, but uses <code>(key) &#8594; testDslOf(integrationFloor())</code> as the creator function. The <code>TestState</code> remains the same but the implementation of the <code>Floor</code> is an <code>IntegrationFloor</code> which does not contain <code>InMemoryDoubles</code> but <code>Jpa</code> repositories.</p>
</div>
<div class="paragraph">
<p>Since the <code>TestState</code> only knows the <code>Floor</code> interface and not the concrete implementation, we can now make any test by changing <strong>a single annotation</strong> from an <code>@Integration</code> to an <code>@Unit</code> test. This property of the TestDsl is particularly helpful for legacy code, because this code often contains a lot of domain logic in the database.</p>
</div>
<div class="paragraph">
<p>In legacy code you can start by writing  integration tests to catch regressions. Once you have pulled the domain logic out of the database and into the application code, you can convert the tests you wrote at the start into unit tests by just changing the annotation. Without a TestDsl, you would have to completely rewrite them at unit level, which is <strong>why many teams do not do this, remain stuck with slow integration tests and cannot iterate much faster</strong> despite increasing test coverage.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="alternatives"><a class="anchor" href="#alternatives"></a><a class="link" href="#alternatives">Alternatives</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Testing without mocks‚Äù <a href="#testing-without-mocks">[9]</a> follows a similar approach to TestDsl. With this approach, however, you have to modify your production code more because we place special test doubles, the so-called ‚Äúnullables‚Äù <a href="#testing-without-mocks-nullables">[10]</a>, directly in the production code.</p>
</div>
<div class="paragraph">
<p>The refactoring tools of our IDE can also prevent certain forms of structure-cementation from our initial test [<a href="#lst:initialer-test">Initial test</a>]. ‚ÄúChange Signature‚Äù is the most helpful refactoring against structure cementing. It works great when you need to remove constructor parameters. Adding them, however, is only useful if the default parameter inserted in tests are very simple and have no dependency on other state in the test. These refactoring tools can also create bugs, when default values are not only set in the test code, but also in the production code, and you forget to change them. It is clear that the Dsl-<code>Builder</code> are more flexible than the change signature refactoring and are better at preventing entity cementation. The same applies to the <code>TestState</code> which allows more flexible customization of the <code>Ports</code>. Refactoring tools are therefore not a replacement, but a supplement for the TestDsl.</p>
</div>
<div class="paragraph">
<p>The refactoring framework Open Rewrite <a href="#open-rewrite">[11]</a> looks promising, but seems to be designed more for framework migrations. It should therefore also be more of a supplement to TestDsl, which focuses on domain logic.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="interim-conclusion"><a class="anchor" href="#interim-conclusion"></a><a class="link" href="#interim-conclusion">Interim conclusion</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>With the TestDsl we can make our test setup:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>standardized for all tests,</p>
</li>
<li>
<p>complete (nothing needs to be outsourced),</p>
</li>
<li>
<p>compact (although nothing has been outsourced),</p>
</li>
<li>
<p>free of irrelevant details,</p>
</li>
<li>
<p>with relevant details highlighted,</p>
</li>
<li>
<p>readable,</p>
</li>
<li>
<p>low-maintenance,</p>
</li>
<li>
<p>parallelizable,</p>
</li>
<li>
<p>fast,</p>
</li>
<li>
<p>and free of structure cementation</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The TestDsl is of course not free. But it is not expensive either. We have to create a foundation with Extension, TestState, Floor and BaseInMemoryDouble. Experience from several JVM and Node projects shows that the maintenance effort is low once this foundation has been laid.</p>
</div>
<div class="paragraph">
<p>It is rather rare that you have to create new entities. You work much more with existing entities and services and restructure them. The initial investment then pays dividends continuously. Since the entire setup is done via the Dsl [<a href="#fig:testdsl-struktur">see figure</a>], only the Dsl is affected by structural changes.</p>
</div>
<div id="fig:testdsl-struktur" class="imageblock">
<div class="content">
<img src="/assets/img/posts/structure-cementing-tests/part1/LL-Test-Dsl-Layer.png" alt="A picture showing">
</div>
<div class="title">Figure 3. The TestDsl is between tests and the structure of the production code</div>
</div>
<div class="paragraph">
<p><a href="#fig:testdsl-struktur">The figure</a> also shows what the actual trade-off is that we make with the Dsl: Loss of feedback on our setup. Without Dsl, you notice whether the setup is ‚Äúannoying‚Äù when writing tests. If you have to write a lot of code for testing, you naturally ask yourself whether there is an easier way to do it. There is a natural pressure to improve the structure. This ‚Äúannoying‚Äù setup can now be hidden in the Dsl. It is therefore all the more important to use the Dsl only for the setup, to leave it as dumb as possible, to define as few combo builders as possible and to keep thinking about whether the structure is on the right track when adapting the Dsl.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="outlook"><a class="anchor" href="#outlook"></a><a class="link" href="#outlook">Outlook</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this part we have seen how to solve structure cementation through redundancy with the TestDsl.</p>
</div>
<div class="paragraph">
<p>In the <a href="Structure-Cementing-Tests-2">part 2</a>, we will take a closer look at the concepts on which the TestDsl is based. We will go into the design of the builder, how to combine the DSL with <code>@SpringBootTest</code>, what the difference between a high- and a low-level TestDsl is, how to keep test doubles synchronized with the production code and why the excessive use of mocking frameworks also leads to structure cementation.</p>
</div>
<div class="paragraph">
<p>In part 3, we will see how to prevent the other kind structure cementation: testing unstable elements instead of modules.</p>
</div>
<div class="paragraph">
<p>If you want even more information on the topic, you can view the TestDsl example code on Github <a href="#test-dsl">[12]</a> or watch the presentation on ‚ÄúBeehive Architecture‚Äù <a href="#beehive-architecture">[13]</a> (in üá©üá™), which is also about the TestDsl.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">
This article was originally published in <a href="https://www.ijug.eu/de/java-aktuell/zeitschrift/java-aktuell-archiv/detailansicht-java-aktuell/java-aktuell-4-24-java-22/">Java Aktuell 4/24</a> in üá©üá™. It is translated and republished here with the magazine&#8217;s permission.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="references"><a class="anchor" href="#references"></a><a class="link" href="#references">References</a></h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="preparatory-refactoring"></a>[1] M. Fowler, ‚ÄúAn example of preparatory refactoring.‚Äù 2015. Available: <a href="https://martinfowler.com/articles/preparatory-refactoring-example.html" class="bare">https://martinfowler.com/articles/preparatory-refactoring-example.html</a></p>
</li>
<li>
<p><a id="arlos-commit"></a>[2] A. Belshee, ‚ÄúArlo‚Äôs Commit Notation.‚Äù 2018. Available: <a href="https://github.com/RefactoringCombos/ArlosCommitNotation" class="bare">https://github.com/RefactoringCombos/ArlosCommitNotation</a></p>
</li>
<li>
<p><a id="mastering-programming"></a>[3] K. Beck, ‚ÄúMastering Programming.‚Äù Available: <a href="https://tidyfirst.substack.com/p/mastering-programming" class="bare">https://tidyfirst.substack.com/p/mastering-programming</a></p>
</li>
<li>
<p><a id="xunit-test-double"></a>[4] G. Meszaros, ‚ÄúTest Double.‚Äù 2011. Available: <a href="http://xunitpatterns.com/Test%20Double.html" class="bare">http://xunitpatterns.com/Test%20Double.html</a></p>
</li>
<li>
<p><a id="object-mother"></a>[5] M. Fowler, ‚ÄúObject Mother.‚Äù 2006. Available: <a href="https://martinfowler.com/bliki/ObjectMother.html" class="bare">https://martinfowler.com/bliki/ObjectMother.html</a></p>
</li>
<li>
<p><a id="ports-and-adapters"></a>[6] 	A. Cockburn, ‚ÄúHexagonal architecture.‚Äù 2005. Available: <a href="https://alistair.cockburn.us/hexagonal-architecture/" class="bare">https://alistair.cockburn.us/hexagonal-architecture/</a></p>
</li>
<li>
<p><a id="spring-2-unit-tests"></a>[7] 	T. Spring, ‚ÄúUnit Testing.‚Äù 2006. Available: <a href="https://docs.spring.io/spring-framework/docs/2.0.4/reference/testing.html#unit-testing" class="bare">https://docs.spring.io/spring-framework/docs/2.0.4/reference/testing.html#unit-testing</a></p>
</li>
<li>
<p><a id="junit5-user-guide-extension-model"></a>[8] T. JUnit5, ‚ÄúJUnit 5 User Guide - Extension Model.‚Äù Available: <a href="https://junit.org/junit5/docs/current/user-guide/#extensions" class="bare">https://junit.org/junit5/docs/current/user-guide/#extensions</a></p>
</li>
<li>
<p><a id="testing-without-mocks"></a>[9] J. Shore, ‚ÄúTesting Without Mocks: A Pattern Language.‚Äù 2023. Available: <a href="https://www.jamesshore.com/v2/projects/nullables/testing-without-mocks" class="bare">https://www.jamesshore.com/v2/projects/nullables/testing-without-mocks</a></p>
</li>
<li>
<p><a id="testing-without-mocks-nullables"></a>[10] 	J. Shore, ‚ÄúNullables.‚Äù 2023. Available: <a href="https://www.jamesshore.com/v2/projects/nullables/testing-without-mocks#nullables" class="bare">https://www.jamesshore.com/v2/projects/nullables/testing-without-mocks#nullables</a></p>
</li>
<li>
<p><a id="open-rewrite"></a>[11] 	T. Moderne, ‚ÄúLarge-scale automated source code refactoring.‚Äù 2024. Available: <a href="https://docs.openrewrite.org/" class="bare">https://docs.openrewrite.org/</a></p>
</li>
<li>
<p><a id="test-dsl"></a>[12] R. Gross, ‚ÄúTestDsl (Avoid structure-cementing Tests).‚Äù 2024. Available: <a href="https://github.com/Richargh/testdsl" class="bare">https://github.com/Richargh/testdsl</a></p>
</li>
<li>
<p><a id="beehive-architecture"></a>[13] R. Gross, ‚ÄúBeehive Architecture üá©üá™‚Äù 2023. Available: <a href="http://richargh.de/talks/#beehive-architecture" class="bare">http://richargh.de/talks/#beehive-architecture</a></p>
</li>
</ul>
</div>
</div>
</div>
</div><!-- Add backlinks to the current page --><div class="related" id="jekyll-seamless-relatedposts">
    <h4 class="medium-small">Related Posts</h4>
    <div class="related-wrapper"><div class="related-group"><a href="/posts/Structure-Cementing-Tests-2">
            <p class="related-title">Structure-cementing tests and how to avoid them 2/3</p>
            <p class="related-excerpt">== Part 2 - Concepts of the TestDsl

Tests should be sensitive to behavioural changes but be insensitive to structural changes.
Tests tha...</p>
          </a></div></div>
      <br/>
    </div></main><div id="copyright">
    <p id="copyright-notice">¬© Richard Gro√ü
         - with help from <a href="https://jekyllrb.com/">Jekyll</a>
        and <a href="https://github.com/raghuveerdotnet/simply-jekyll">Simply Jekyll Theme</a></p>
</div> </div>
        <button class="scroll-to-top" id="scroll-to-top"><i class="fa fa-chevron-up"></i></button>
    </div>
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <script>
        document.getElementById("scroll-to-top").addEventListener("click", function() {
            window.scrollTo({top: 0, left: 0, behavior: 'smooth'});
        });
    </script></body>
</html>
